name: Bump Version and Create Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'The type of version bump'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
          - stable # For going from pre-release to stable
          - alpha
          - beta
          - rc   # release candidate
          - post # post-release
          - dev  # dev-release

jobs:
  run-tests-and-wait:
    uses: ./.github/workflows/run-tests.yml

  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    needs: run-tests-and-wait
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv and set the python version
        uses: astral-sh/setup-uv@v6
        with:
          python-version: '3.12'
          enable-cache: true

      - name: Install dependencies
        run: uv sync --locked --all-extras --dev

      - name: Configure Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version and get new tag
        id: bump
        run: |
          uv version --bump ${{ inputs.bump_type }}
          NEW_VERSION=$(grep '^version = ' pyproject.toml | cut -d '"' -f 2)
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          uv lock

      # STEP 1: Generate all changelog files using the --bump flag
      - name: Update Main Changelog File
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --tag ${{ steps.bump.outputs.tag }} --output CHANGELOG.md

      - name: Extract Latest Changelog for Release Body
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --unreleased --tag ${{ steps.bump.outputs.tag }} --strip all
        env:
          OUTPUT: LATEST_CHANGELOG.md

      # STEP 2: Commit all file changes together
      - name: Commit All Changes
        run: |
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore(release): bump version to ${{ steps.bump.outputs.tag }}"

      # STEP 3: Create the tag for the final commit
      - name: Create Git Tag
        run: |
          git tag -a "${{ steps.bump.outputs.tag }}" -m "Release ${{ steps.bump.outputs.tag }}"

      # STEP 4: Push the commit and the tag
      - name: Push All Changes
        run: |
          git push --follow-tags

      - name: uv build
        run: |
          uv build

      # STEP 5: Create the release
      - name: Create Stable GitHub Release
        if: "!(contains(inputs.bump_type, 'alpha') || contains(inputs.bump_type, 'beta') || contains(inputs.bump_type, 'rc'))"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.bump.outputs.tag }} \
            --title "Release ${{ steps.bump.outputs.tag }}" \
            --notes-file ${{ steps.changelog.outputs.changelog }} \
            dist/* # <-- This uploads the build files

      - name: Create Pre-Release on GitHub
        if: "contains(inputs.bump_type, 'alpha') || contains(inputs.bump_type, 'beta') || contains(inputs.bump_type, 'rc')"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.bump.outputs.tag }} \
            --title "Release ${{ steps.bump.outputs.tag }}" \
            --notes-file ${{ steps.changelog.outputs.changelog }} \
            --prerelease \
            dist/* # <-- This uploads the build files

      - name: Fetch pypi token from Akeyless
        uses: LanceMcCarthy/akeyless-action@d42e07875b1cc7162afd290722babbaf879a86e6
        id: fetch-secrets
        with:
          access-id: ${{ secrets.AKEYLESS_ACCESS_ID }}
          static-secrets: '{"/pypi":"pypi"}'

      - name: Publish to PyPi
        run: |
          uv publish --token ${{ steps.fetch-secrets.outputs.pypi }}

  publish:
    name: Publish Doc Site to S3
    runs-on: ubuntu-latest
    needs: bump-version
    permissions:
        id-token: write
        contents: read
    steps:
        - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
              persist-credentials: false
        - name: configure aws credentials
          uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
          with:
              role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
              role-session-name: docs-deploy
              aws-region: us-east-1
        - name: Install uv
          uses: astral-sh/setup-uv@v6
        - name: Publish
          run: |
              cd docs/python
              uv run build.py
              sudo apt update
              sudo apt-get install -y ruby ruby-dev jq
              sudo gem install bundler
              cd ../build
              cp ../../README.md _includes/project_readme.md
              cp ../../CHANGELOG.md _includes/project_changelog.md
              sudo bundle install
              sudo bundle exec jekyll build
              cd _site
              aws s3 cp . s3://clearskies.info/modules/producers/clear-skies-akeyless-custom-producer/ --recursive
              cd ../../python
              aws s3 cp s3://clearskies.info/modules/manifest.json . || touch manifest.json
              uv run update_manifest.py --pyproject_file=../../pyproject.toml --modules_location=modules
              aws s3 cp manifest.json s3://clearskies.info/modules/manifest.json
              echo "Updated manifest.json in S3"
