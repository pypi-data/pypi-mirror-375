<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pohualli Calendar Converter</title>
<script>
// Apply saved theme early to avoid flash
(function(){
  try { var th = localStorage.getItem('pohualli_theme'); if(th){ document.documentElement.setAttribute('data-theme', th); } } catch(e){}
})();
// Preserve scroll position across full page reloads (form submissions)
(function(){
  const KEY='pohualli_scroll_y';
  // When a submit button is clicked, store current scroll position
  document.addEventListener('click', function(ev){
    const btn = ev.target && ev.target.closest('button');
    if(!btn) return;
    if(btn.type === 'submit'){ sessionStorage.setItem(KEY, String(window.scrollY)); }
  }, true);
  // On load, restore and then clear
  window.addEventListener('DOMContentLoaded', function(){
    try {
      const y = sessionStorage.getItem(KEY);
      if(y){ window.scrollTo(0, parseInt(y,10)||0); sessionStorage.removeItem(KEY); }
    } catch(_){}
  });
})();
</script>
<style>
/* --- Color System (basic palette) --- */
:root {
  --color-bg: #0f1115;
  --color-bg-alt: #171b22;
  --color-panel: #1f2530;
  --color-panel-alt: #262f3b;
  --color-border: #324050;
  --color-border-soft: #2b3542;
  --color-text: #f5f7fa;
  --color-text-soft: #c2c9d2;
  --color-accent: #2d83f4;
  --color-accent-accent: #4a9bff;
  --color-accent-glow: rgba(77,155,255,0.25);
  --color-danger: #ff4d61;
  --color-warning: #f4b742;
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 14px;
  --shadow-sm: 0 2px 4px -1px rgba(0,0,0,.35), 0 1px 1px rgba(0,0,0,.3);
  --shadow-md: 0 4px 10px -2px rgba(0,0,0,.45), 0 2px 4px rgba(0,0,0,.35);
  --focus-ring: 0 0 0 3px var(--color-accent-glow), 0 0 0 1px var(--color-accent);
  font-synthesis: none;
  text-rendering: optimizeLegibility;
}

/* Light theme overrides */
:root[data-theme='light'] {
  --color-bg: #f5f7fa;
  --color-bg-alt: #eef1f5;
  --color-panel: #ffffff;
  --color-panel-alt: #f1f5f9;
  --color-border: #cfd8e3;
  --color-border-soft: #d9e1ea;
  --color-text: #1f2a36;
  --color-text-soft: #4d5b68;
  --color-accent: #2d7df4;
  --color-accent-accent: #3f8dff;
  --color-accent-glow: rgba(45,125,244,0.25);
  --color-danger: #d93046;
  --color-warning: #c98607;
  --shadow-sm: 0 2px 4px -1px rgba(0,0,0,.12), 0 1px 1px rgba(0,0,0,.08);
  --shadow-md: 0 6px 14px -2px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.12);
}
html, body { height:100%; }
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  margin: 0;
  background: radial-gradient(circle at 25% 20%, var(--color-bg-alt), var(--color-bg) 65%) fixed;
  color: var(--color-text);
  line-height:1.4;
  transition: background .4s ease, color .25s ease;
}
.page-wrap { max-width:1250px; margin:0 auto; padding:2rem 2.2rem 3.5rem; }
header { margin:0 0 1.75rem; }
header h1 { margin:0 0 .4rem; font-size:clamp(1.8rem, 2.6vw, 2.4rem); letter-spacing:.5px; background:linear-gradient(90deg,#4a9bff,#8bc8ff); -webkit-background-clip:text; background-clip:text; color:transparent; }
header p { margin:0; color: var(--color-text-soft); }
form {
  margin-bottom:1.75rem;
  background:linear-gradient(145deg,var(--color-panel),var(--color-panel-alt));
  padding:1.15rem 1.35rem 1.25rem;
  border:1px solid var(--color-border);
  border-radius:var(--radius-lg);
  display:grid;
  grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
  gap:1rem 1.1rem;
  box-shadow: var(--shadow-sm);
  position:relative;
}
form:focus-within { box-shadow: var(--shadow-md); border-color: var(--color-accent); }
label { display:block; margin:.15rem 0 .35rem; font-weight:600; font-size:.8rem; letter-spacing:.5px; text-transform:uppercase; color: var(--color-text-soft); }
input, select { padding:.55rem .65rem; font-size:.95rem; width:100%; border:1px solid var(--color-border); border-radius:var(--radius-sm); background: #12161c; color: var(--color-text); transition:border-color .15s, background .15s; }
input:focus, select:focus { outline:none; border-color: var(--color-accent); box-shadow: var(--focus-ring); background:#10141a; }
button { padding:.6rem 1.05rem; font-size:.9rem; font-weight:600; letter-spacing:.4px; border:none; border-radius:var(--radius-sm); cursor:pointer; background:linear-gradient(90deg,var(--color-accent),var(--color-accent-accent)); color:#fff; box-shadow:0 2px 4px -1px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,0.04); display:inline-flex; align-items:center; gap:.4rem; position:relative; }
button:hover { filter:brightness(1.08); }
button:active { transform:translateY(1px); }
button:focus { outline:none; box-shadow: var(--focus-ring); }
button.download { background:linear-gradient(90deg,#3aa86d,#52c888); }
button.download:hover { filter:brightness(1.1); }
button.danger { background:linear-gradient(90deg,#ff4d61,#ff6f7f); }
.actions { grid-column:1 / -1; display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.2rem; }
pre { background:#10141a; color:#e6edf3; padding:1rem 1.1rem; overflow:auto; border-radius:var(--radius-md); border:1px solid var(--color-border-soft); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02); }
.error { color:var(--color-danger); font-weight:600; margin: .5rem 0 1rem; }
footer { margin-top:2.5rem; font-size:.8rem; color:var(--color-text-soft); text-align:center; opacity:.85; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(210px,1fr)); gap:1rem; }
.card { position:relative; background:linear-gradient(160deg,#1e242e,#232b36 55%, #1c222b); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:.85rem .95rem .9rem; box-shadow: var(--shadow-sm); transition:transform .15s, box-shadow .15s, border-color .2s; }
.card::before { content:""; position:absolute; inset:0; border-radius:inherit; padding:1px; background:linear-gradient(120deg, transparent 0%, rgba(77,155,255,0.15) 45%, transparent 90%); -webkit-mask:linear-gradient(#000,#000) content-box, linear-gradient(#000,#000); mask:linear-gradient(#000,#000) content-box, linear-gradient(#000,#000); -webkit-mask-composite:xor; mask-composite:exclude; opacity:.6; pointer-events:none; }
/* Light theme refinements */
:root[data-theme='light'] body { background: radial-gradient(circle at 25% 20%, var(--color-bg), var(--color-bg-alt) 75%) fixed; }
:root[data-theme='light'] form, :root[data-theme='light'] details, :root[data-theme='light'] .card { background: var(--color-panel); }
:root[data-theme='light'] input, :root[data-theme='light'] select { background:#ffffff; color: var(--color-text); }
:root[data-theme='light'] pre { background:#ffffff; color:#1f2a36; }
:root[data-theme='light'] header h1 { background:linear-gradient(90deg,#2d7df4,#5aa9ff); -webkit-background-clip:text; background-clip:text; }
.card:hover { transform:translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-accent); }
.card h3 { margin:.1rem 0 .45rem; font-size:.8rem; letter-spacing:.6px; font-weight:700; text-transform:uppercase; color: var(--color-text-soft); }
.value { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:.95rem; word-break:break-word; }
details { border-radius:var(--radius-lg); background:linear-gradient(145deg,var(--color-panel),var(--color-panel-alt)); border:1px solid var(--color-border); box-shadow:var(--shadow-sm); }
/* Themed panel wrapper to avoid hard-coded white backgrounds */
.panel { background:linear-gradient(155deg,var(--color-panel),var(--color-panel-alt)); border:1px solid var(--color-border); border-radius:var(--radius-lg); box-shadow:var(--shadow-sm); }
.panel h2 { margin-top:0; }
.panel p { color: var(--color-text-soft); }
:root[data-theme='light'] .panel { background: var(--color-panel); }
:root:not([data-theme='light']) .panel { background:linear-gradient(155deg,#1a222b,#202a35 55%, #182027); }
.panel table { width:100%; border-collapse:collapse; }
.panel table thead th { background:rgba(255,255,255,0.06); font-weight:600; }
:root[data-theme='light'] .panel table thead th { background:#f2f6fa; }
.panel table tbody tr:nth-child(even){ background:rgba(255,255,255,0.04); }
:root[data-theme='light'] .panel table tbody tr:nth-child(even){ background:#f5f9fc; }
.panel table tbody tr:nth-child(odd){ background:rgba(255,255,255,0.015); }
:root[data-theme='light'] .panel table tbody tr:nth-child(odd){ background:#ffffff; }
.panel table td, .panel table th { padding:.35rem .5rem; border-bottom:1px solid var(--color-border-soft); }
.panel .note { font-size:.65rem; color: var(--color-text-soft); }
details[open] { box-shadow:var(--shadow-md); }
details > summary { padding:.9rem 1.05rem; list-style:none; cursor:pointer; font-weight:600; letter-spacing:.4px; color: var(--color-text-soft); }
details > summary::-webkit-details-marker { display:none; }
details form { background:transparent; box-shadow:none; border:none; padding:.2rem 1.05rem 1rem; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
details form label { font-size:.65rem; }
details form input { background:#141a22; }

/* --- Improved dark mode readability for Corrections & Offsets --- */
:root:not([data-theme='light']) details { background:linear-gradient(155deg,#242d38,#1b222b 70%, #181e25); border-color:#3b4b5c; }
:root:not([data-theme='light']) details > summary { color:#d0d7e0; background:linear-gradient(120deg,#242f3a,#1e262f); border-bottom:1px solid #334252; border-top-left-radius:var(--radius-lg); border-top-right-radius:var(--radius-lg); }
:root:not([data-theme='light']) details[open] > summary { box-shadow:inset 0 -1px 0 #334252; }
:root:not([data-theme='light']) details form label { color:#b7c2cc; letter-spacing:.6px; }
:root:not([data-theme='light']) details form input { background:#1f2731; border:1px solid #3a4a5a; color:#ecf2f8; }
:root:not([data-theme='light']) details form input:focus { border-color: var(--color-accent); box-shadow: var(--focus-ring); background:#1b222b; }
:root:not([data-theme='light']) details form input::placeholder { color:#6b7782; }

/* Light mode subtle distinction */
:root[data-theme='light'] details > summary { background:linear-gradient(90deg,#f8fafc,#ecf2f8); color:#2e3944; border-bottom:1px solid #d6e0ea; }
:root[data-theme='light'] details form input { border:1px solid #c3d0db; }

@media (max-width: 720px){
  .page-wrap { padding:1.15rem 1.1rem 2.5rem; }
  form { grid-template-columns: repeat(auto-fill,minmax(170px,1fr)); }
  .grid { grid-template-columns: repeat(auto-fill,minmax(170px,1fr)); }
}
/* --- Enhanced progress bar styles --- */
.pbar-wrap { position:relative; background:#13202a; border:1px solid #2e3f4c; height:18px; border-radius:10px; overflow:hidden; box-shadow: inset 0 0 4px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,0.03); }
.pbar { height:100%; background:linear-gradient(90deg,#1f6ad6,#2d83f4,#4a9bff); background-size:200% 100%; position:relative; transition:width .35s ease; display:flex; align-items:center; justify-content:center; font-size:.65rem; font-weight:600; letter-spacing:.5px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.6); animation:pbarShift 3s linear infinite; }
.pbar::after { content:""; position:absolute; inset:0; background:repeating-linear-gradient(45deg,rgba(255,255,255,0.18) 0 8px, rgba(255,255,255,0) 8px 16px); mix-blend-mode:overlay; opacity:.55; }
@keyframes pbarShift { 0% {background-position:0 0;} 100% {background-position:200% 0;} }
:root .pbar-done { animation:none !important; }
.pbar-static { animation:none !important; }
:root[data-theme='light'] .pbar-wrap { background:#f2f7fa; border-color:#c8d5e0; }
:root[data-theme='light'] .pbar { text-shadow:none; }
</style>
<script>
// --- Persistence of correction and config fields via localStorage ---
const STORAGE_KEY = 'pohualli_corrections_v1';
const THEME_KEY = 'pohualli_theme';
function loadCorrectionsFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    const map = {
      new_era: 'newEra',
      ybm: 'ybm',
      ybd: 'ybd',
      tz_off: 'tz_off',
      tzn_off: 'tzn_off',
      haab_off: 'haab_off',
      g_off: 'g_off',
      lcd_off: 'lcd_off',
      week_off: 'week_off',
      c819s: 'c819s',
      c819d: 'c819d'
    };
    for(const [k, id] of Object.entries(map)){
      if(data[k] !== undefined && data[k] !== null){
        const el = document.querySelector(`[name="${k}"]`) || document.getElementById(id);
        if(el && el.value === '') el.value = data[k];
      }
    }
  } catch(e) { console.warn('Failed to load stored corrections', e); }
}
function collectCurrentCorrections(){
  const fields = ['new_era','ybm','ybd','tz_off','tzn_off','haab_off','g_off','lcd_off','week_off','c819s','c819d'];
  const out = {};
  for(const f of fields){
    const el = document.querySelector(`[name="${f}"]`) || document.getElementById(f);
    if(el && el.value !== '') out[f] = el.value;
  }
  return out;
}
function saveCorrections(){
  const data = collectCurrentCorrections();
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  catch(e){ alert('Unable to persist locally: ' + e); return; }
  flashStatus('Saved locally');
}
function resetCorrections(){
  localStorage.removeItem(STORAGE_KEY);
  flashStatus('Cleared saved corrections');
}
function resetToDefaults(){
  // Remove any persisted custom values
  localStorage.removeItem(STORAGE_KEY);
  // Default constants mirrored from backend defaults
  const defaults = {
    new_era: '584285', // ABSOLUTE.new_era default
    ybm: '',
    ybd: '',
    tz_off: '0',
    tzn_off: '0',
    haab_off: '0',
    g_off: '0',
    lcd_off: '0',
    week_off: '0',
    c819s: '0',
    c819d: '0'
  };
  for(const [k,v] of Object.entries(defaults)){
    const el = document.querySelector(`[name="${k}"]`);
    if(el) el.value = v;
  }
  flashStatus('Defaults applied (submit to use)');
}
function flashStatus(msg){
  let bar = document.getElementById('statusbar');
  if(!bar){
    bar = document.createElement('div');
    bar.id = 'statusbar';
    bar.style.position='fixed';
    bar.style.bottom='1rem';
    bar.style.right='1rem';
    bar.style.background='#333';
    bar.style.color='#fff';
    bar.style.padding='.5rem .75rem';
    bar.style.borderRadius='6px';
    bar.style.opacity='0.95';
    document.body.appendChild(bar);
  }
  bar.textContent = msg;
  setTimeout(()=>{ if(bar) bar.remove(); }, 2500);
}
document.addEventListener('DOMContentLoaded', loadCorrectionsFromStorage);

// Theme toggle
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  try { localStorage.setItem(THEME_KEY, t); } catch(e){}
  const btn = document.getElementById('themeToggle');
  if(btn){ btn.textContent = t === 'light' ? 'Dark Mode' : 'Light Mode'; }
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  applyTheme(cur === 'light' ? 'dark' : 'light');
}
document.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem(THEME_KEY);
  if(saved){ applyTheme(saved); } else { applyTheme(document.documentElement.getAttribute('data-theme')||'dark'); }
});

function downloadJSON(){
  const pre = document.getElementById('rawjson');
  if(!pre) return;
  const blob = new Blob([pre.textContent], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'pohualli_result.json';
  a.click();
}
async function runAutocorr(){
  const jdnField = document.getElementById('jdn');
  if(!jdnField.value){ alert('Enter JDN first then press Derive.'); return; }
  const params = new URLSearchParams();
  params.set('jdn', jdnField.value);
  const map = {
    tzolkin: 'ac_tz',
    haab: 'ac_h',
    g: 'ac_g',
    long_count: 'ac_lc',
    year_bearer: 'ac_yb',
    cycle819_station: 'ac_819s',
    cycle819_value: 'ac_819v',
    dir_color: 'ac_dc'
  };
  for(const [k,id] of Object.entries(map)){
    const v = document.getElementById(id).value.trim();
    if(v) params.set(k, v);
  }
  const pre = document.getElementById('ac_result');
  pre.style.display='block';
  pre.textContent='Calculating...';
  const resp = await fetch('/api/derive-autocorr?' + params.toString());
  let data = null; let rawText = '';
  try { data = await resp.clone().json(); } catch(_) { try { rawText = await resp.text(); } catch(_){} }
  if(resp.ok && data){
    pre.textContent = JSON.stringify(data, null, 2);
  } else {
    const errMsg = data && (data.error || data.detail) ? (data.error || data.detail) : (rawText.trim() || 'HTTP '+resp.status);
    pre.textContent = 'Error: ' + errMsg;
  }
}

// -------- Asynchronous Range Job UI ---------
let activeJobId = null;
let pollTimer = null;
let elapsedTimer = null; // client-side smoother elapsed updates
let activeJobStartedEpoch = null; // unix seconds from server
async function startRangeJob(ev){
  ev.preventDefault();
  if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
  const form = ev.target;
  const payload = {};
  const map = {
    start: 'r_start', end: 'r_end', step: 'r_step', limit:'r_limit', tzolkin_value:'r_tzval', tzolkin_name:'r_tzname', haab_day:'r_haab_day', haab_month:'r_haab_month', year_bearer_name:'r_year_bearer_name', dir_color:'r_dir_color', weekday:'r_weekday', long_count:'r_long_count', fields:'r_fields'
  };
  const box = document.getElementById('rangeJobBox');
  box.textContent = 'Submitting job...';
  for(const [api, field] of Object.entries(map)){
    const el = form.querySelector(`[name="${field}"]`);
  if(el && el.value.trim() !== '') payload[api] = el.value.trim();
  }
  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true; btn.textContent='Starting...';
  try{
  const resp = await fetch('/api/range-jobs', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await resp.json();
    activeJobId = data.id;
  activeJobStartedEpoch = data.started || null;
  const stopBtn = document.getElementById('btnStopJob'); if(stopBtn){ stopBtn.disabled=false; }
    renderJobStatus(data);
    pollTimer = setInterval(pollStatus, 750);
  startElapsedLoop();
  }catch(e){
    renderJobError(String(e));
  } finally {
    btn.disabled=false; btn.textContent='Search Range';
  }
}
let _lastExampleIdx = {convert:-1, autocorr:-1, sync:-1, async:-1};
function _pickExample(kind, arr){
  if(!Array.isArray(arr) || !arr.length) return null;
  let idx = Math.floor(Math.random()*arr.length);
  if(arr.length>1 && idx === _lastExampleIdx[kind]){ idx = (idx+1)%arr.length; }
  _lastExampleIdx[kind] = idx;
  return arr[idx];
}
function fillAsyncExample(){
  const f = document.getElementById('asyncRangeForm');
  if(!f) return;
  const examples = [
    {start:'2451545', end:'2452000', tz:'Ik', limit:'12', fields:'jdn,gregorian_date,tzolkin_name,long_count'},
    {start:'584283', end:'584900', tz:'Ahau', limit:'7', fields:'jdn,gregorian_date,haab_month_name,tzolkin_name'},
    {start:'1872000', end:'1872600', tz:'Ben', limit:'9', fields:'jdn,gregorian_date,year_bearer_name'},
    {start:'2305447', end:'2306000', tz:'Caban', limit:'6', fields:'jdn,gregorian_date,tzolkin_value,tzolkin_name'}
  ];
  const pick = _pickExample('async', examples);
  if(!pick) return;
  const set=(n,v)=>{ const el=f.querySelector(`[name="${n}"]`); if(el) el.value=v; };
  set('r_start', pick.start);
  set('r_end', pick.end);
  set('r_limit', pick.limit);
  set('r_tzname', pick.tz);
  set('r_fields', pick.fields);
  flashStatus('Async range example loaded');
}

// ---- Additional Example Fillers ----
function fillConvertExample(){
  const examples = [
    { jdn: '2451545', label:'J2000.0' },
    { jdn: '2440588', label:'Unix Epoch' },
    { jdn: '584283', label:'GMT Base' },
    { jdn: '1872000', label:'12.0.0.0.0' },
    { jdn: '2305447', label:'9.9.16.0.0' }
  ];
  const pick = _pickExample('convert', examples);
  if(!pick) return;
  const jdn = document.getElementById('jdn');
  if(jdn) jdn.value = pick.jdn;
  const ybm = document.getElementById('ybm'); if(ybm) ybm.value='';
  const ybd = document.getElementById('ybd'); if(ybd) ybd.value='';
  flashStatus(`Example conversion loaded (${pick.label})`);
}
function fillCorrectionsExample(){
  const map = {
    tz_off: '0',
    tzn_off: '0',
    haab_off: '0',
    g_off: '0',
    lcd_off: '0',
    week_off: '0',
    c819s: '0',
    c819d: '0'
  };
  for(const [k,v] of Object.entries(map)){
    const el = document.querySelector(`[name="${k}"]`); if(el) el.value = v;
  }
  flashStatus('Example corrections loaded (all zero)');
}
function fillAutocorrExample(){
  const jdnInput = document.getElementById('jdn');
  const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
  async function loadFromJdn(jdn){
    try {
      const resp = await fetch('/api/convert?jdn=' + jdn);
      if(!resp.ok) throw new Error('bad status');
      const data = await resp.json();
      // Build specs directly from composite so they always match this JDN
      set('ac_tz', `${data.tzolkin_value} ${data.tzolkin_name}`);
      set('ac_h', `${data.haab_day} ${data.haab_month_name}`);
      // g value not exposed separately; leave blank so derivation can compute others without stricter constraint
      set('ac_g', '');
      if(Array.isArray(data.long_count)){
        set('ac_lc', data.long_count.join('.'));
      } else if(typeof data.long_count === 'string') {
        set('ac_lc', data.long_count);
      }
      set('ac_yb', `${data.year_bearer_value} ${data.year_bearer_name}`);
      set('ac_819s', data.cycle819_station);
      set('ac_819v', data.cycle819_value);
      set('ac_dc', data.dir_color_str);
      flashStatus('Autocorr example derived from JDN');
    } catch(e){
      flashStatus('Failed to load composite for JDN');
    }
  }
  if(jdnInput && jdnInput.value){
    loadFromJdn(jdnInput.value.trim());
    return;
  }
  // If no JDN provided yet, pick a conversion example JDN first then derive from it.
  const exampleJdns = ['2451545','2440588','584283','1872000','2305447'];
  const pick = _pickExample('autocorr', exampleJdns);
  if(pick){
    if(jdnInput) jdnInput.value = pick;
    loadFromJdn(pick);
  }
}
function fillSyncRangeExample(){
  const f = document.getElementById('syncRangeForm');
  if(!f) return;
  const examples = [
    {start:'2451545', end:'2451700', tz:'Imix', limit:'5', fields:'jdn,gregorian_date,tzolkin_name,long_count'},
    {start:'584283', end:'584500', tz:'Ik', limit:'8', fields:'jdn,gregorian_date,haab_month_name,long_count'},
    {start:'1872000', end:'1872120', tz:'Ahau', limit:'10', fields:'jdn,gregorian_date,tzolkin_value,tzolkin_name'},
    {start:'2305447', end:'2305600', tz:'Ben', limit:'6', fields:'jdn,gregorian_date,year_bearer_name,long_count'}
  ];
  const pick = _pickExample('sync', examples);
  if(!pick) return;
  const set=(n,v)=>{ const el=f.querySelector(`[name="${n}"]`); if(el) el.value=v; };
  set('r_start', pick.start);
  set('r_end', pick.end);
  set('r_tzname', pick.tz);
  set('r_limit', pick.limit);
  set('r_fields', pick.fields);
  flashStatus('Sync range example loaded');
}

// --- Live Gregorian date preview for JDN field ---
let _jdnPreviewTimer = null;
async function _fetchGregorian(jdn){
  try {
    const resp = await fetch(`/api/convert?jdn=${jdn}`);
    if(!resp.ok) return null;
    const data = await resp.json();
    return data.gregorian_date;
  } catch { return null; }
}
function attachJdnPreview(){
  const input = document.getElementById('jdn');
  if(!input) return;
  let preview = document.getElementById('jdnGregorianPreview');
  if(!preview){
    preview = document.createElement('div');
    preview.id='jdnGregorianPreview';
    preview.style.fontSize='.65rem';
    preview.style.marginTop='.2rem';
    preview.style.color='var(--color-text-soft)';
    input.parentElement.appendChild(preview);
  }
  const update = ()=>{
    const v = input.value.trim();
    if(!v){ preview.textContent=''; return; }
    if(_jdnPreviewTimer) clearTimeout(_jdnPreviewTimer);
    _jdnPreviewTimer = setTimeout(async ()=>{
      const g = await _fetchGregorian(v);
      preview.textContent = g ? `Gregorian: ${g}` : '';
    }, 300);
  };
  input.addEventListener('input', update);
  // initial if pre-populated
  if(input.value) update();
}
document.addEventListener('DOMContentLoaded', attachJdnPreview);
async function pollStatus(){
  if(!activeJobId){ return; }
  try {
    const resp = await fetch(`/api/range-jobs/${activeJobId}`);
    if(!resp.ok){ throw new Error('Status ' + resp.status); }
    const data = await resp.json();
    renderJobStatus(data);
    if(['completed','error','canceled'].includes(data.status)){
      clearInterval(pollTimer); pollTimer=null;
    }
  } catch(e){
    console.warn('Poll failed', e);
  }
}
async function stopActiveJob(){
  if(!activeJobId) return;
  try {
    const resp = await fetch(`/api/range-jobs/${activeJobId}/cancel`, {method:'POST'});
    if(resp.ok){
      const data = await resp.json();
      renderJobStatus(data);
    }
  } finally {
    if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
    const stopBtn = document.getElementById('btnStopJob');
    if(stopBtn){ stopBtn.disabled = true; }
  }
}
function renderJobError(msg){
  const box = document.getElementById('rangeJobBox');
  box.innerHTML = `<div style="color:var(--color-danger);">${msg}</div>`;
}
function renderJobStatus(data){
  const box = document.getElementById('rangeJobBox');
  // Cache job start time for smoother elapsed updates
  if(data.started && !activeJobStartedEpoch){ activeJobStartedEpoch = data.started; }
  const pct = data.total ? ((data.scanned / data.total)*100).toFixed(1) : '0.0';
  const fieldList = Array.isArray(data.fields) ? data.fields : [];
  const rows = (data.matches||[]).map(r=>{
    return '<tr>' + fieldList.map(f=>{
      if(f==='jdn' && fieldList.includes('gregorian_date')){
        return `<td>${r['jdn']} (${r['gregorian_date']||''})</td>`;
      }
      return `<td>${r[f]||''}</td>`;
    }).join('') + '</tr>';
  }).join('');
  const elapsedStr = (typeof data.elapsed === 'number') ? data.elapsed.toFixed(2) : '';
  const startVal = (data.start !== undefined && data.start !== null) ? data.start : (data.range_start !== undefined ? data.range_start : '—');
  const endVal = (data.end !== undefined && data.end !== null) ? data.end : (data.range_end !== undefined ? data.range_end : '—');
  const stepVal = (data.step !== undefined && data.step !== null) ? data.step : (data.step_size !== undefined ? data.step_size : '—');
  box.innerHTML = `
    <div style="display:flex; align-items:center; gap:.75rem; margin-bottom:.5rem; flex-wrap:wrap;">
      <strong>Job ${data.id}</strong>
      <span>Status: ${data.status}</span>
      <span>Scanned: ${data.scanned}/${data.total}</span>
      <span>Matches: ${data.count}</span>
      <span>${pct}%</span>
  ${data.status==='running'?'<button type="button" onclick="stopActiveJob()">Stop</button>':''}
    </div>
    <div class="pbar-wrap" aria-label="Progress" style="margin-bottom:.55rem;">
      <div class="pbar ${['completed','canceled','error'].includes(data.status)?'pbar-done pbar-static':''}" style="width:${pct}%">${pct}%</div>
    </div>
    <div class="job-meta" style="font-size:.6rem; opacity:.75; margin:-.35rem 0 .55rem; display:flex; gap:1rem; flex-wrap:wrap;">
  <span>Start: <span id="jobMetaStart">${startVal}</span></span>
  <span>End: <span id="jobMetaEnd">${endVal}</span></span>
  <span>Step: <span id="jobMetaStep">${stepVal}</span></span>
      <span>Limit: ${data.limit || '∞'}</span>
      <span>Elapsed: <span id="jobMetaElapsed">${elapsedStr}</span>s</span>
      ${data.partial ? '<span style="color:var(--color-warning); font-weight:600;">Partial</span>' : ''}
    </div>
    <div style="max-height:260px; overflow:auto; border:1px solid #2f3c49; border-radius:6px;">
      <table style="border-collapse:collapse; width:100%; font-size:.7rem;">
  <thead><tr>${fieldList.map(f=>`<th style='text-align:left; padding:.3rem .45rem; border-bottom:1px solid #3a4b5a;'>${f}</th>`).join('')}</tr></thead>
  <tbody>${rows || '<tr><td style="padding:.4rem;" colspan="'+(fieldList.length||1)+'">(no matches yet)</td></tr>'}</tbody>
      </table>
    </div>
  `;
}
function startElapsedLoop(){
  if(elapsedTimer){ clearInterval(elapsedTimer); elapsedTimer=null; }
  if(!activeJobStartedEpoch) return;
  elapsedTimer = setInterval(()=>{
    const el = document.getElementById('jobMetaElapsed');
    if(!el){ return; }
    // Stop updating if job finished
    const jobDone = !['pending','running'].includes(document.getElementById('rangeJobBox')?.textContent.includes('Status: running') ? 'running' : '');
    if(jobDone && pollTimer === null){ clearInterval(elapsedTimer); elapsedTimer=null; return; }
    const now = Date.now()/1000;
    const delta = now - activeJobStartedEpoch;
    if(delta >= 0){ el.textContent = delta.toFixed(2); }
  }, 250);
}
document.addEventListener('DOMContentLoaded', ()=>{
  const asyncForm = document.getElementById('asyncRangeForm');
  if(asyncForm){ asyncForm.addEventListener('submit', startRangeJob); }
});
</script>
</head>
<body>
<div class="page-wrap">
<header>
  <h1>Pohualli Calendar Converter</h1>
  <p>Enter parameters to view composite Mesoamerican calendar data.</p>
</header>
<form method="get" action="/">
  <div>
    <label for="jdn">Julian Day Number</label>
    <input type="number" id="jdn" name="jdn" value="{{ comp.jdn if comp else '' }}" required />
  </div>
  <div>
    <label for="newEra">New Era (override)</label>
    <input type="number" id="newEra" name="new_era" value="{{ new_era if new_era is not none else '' }}" />
  </div>
  <div>
    <label for="preset">Correlation Preset</label>
    <select id="preset" name="preset">
      <option value="">(none)</option>
      {% for p in presets %}
        <option value="{{ p.name }}" {% if active_preset == p.name %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="culture">Culture (Year Bearer)</label>
    <select id="culture" name="culture">
      <option value="maya" {% if culture == 'maya' %}selected{% endif %}>Maya</option>
      <option value="aztec" {% if culture == 'aztec' %}selected{% endif %}>Aztec</option>
    </select>
  </div>
  <div>
    <label for="ybm">Year Bearer Month</label>
    <input type="number" id="ybm" name="ybm" min="0" max="18" value="{{ ybm if ybm is not none else '' }}" />
  </div>
  <div>
    <label for="ybd">Year Bearer Day</label>
    <input type="number" id="ybd" name="ybd" min="0" max="19" value="{{ ybd if ybd is not none else '' }}" />
  </div>
  <div class="actions">
  <button type="submit">Convert</button>
    {% if comp %}<button class="download" type="button" onclick="downloadJSON()">Download JSON</button>{% endif %}
  <button type="button" onclick="saveCorrections()">Save Corrections</button>
  <button type="button" onclick="resetCorrections()">Reset Saved</button>
  <button type="button" onclick="resetToDefaults()">Defaults</button>
  <button type="button" onclick="fillConvertExample()">Example</button>
  <button type="button" id="themeToggle" onclick="toggleTheme()" style="margin-left:auto;">Light Mode</button>
  </div>
</form>
<p style="margin-top:-1.2rem; font-size:.7rem; color:var(--color-text-soft);">Aztec mode subtracts 364 days before deriving the Year Bearer, shifting numbering vs Maya.</p>
<details style="margin-bottom:1.25rem; padding:1rem 1.25rem; border-radius:8px;">
  <summary style="font-weight:600; cursor:pointer;">Corrections & Offsets</summary>
  <form method="get" action="/" style="margin-top:.8rem; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.75rem;">
    <input type="hidden" name="jdn" value="{{ comp.jdn if comp else '' }}" />
    <label>Tzolkin Num Off<input type="number" name="tz_off" value="{{ corr.tzolkin }}" /></label>
    <label>Tzolkin Name Off<input type="number" name="tzn_off" value="{{ corr.tzolkin_name }}" /></label>
    <label>Haab Off<input type="number" name="haab_off" value="{{ corr.haab }}" /></label>
    <label>G Off<input type="number" name="g_off" value="{{ corr.g }}" /></label>
    <label>LCD Off<input type="number" name="lcd_off" value="{{ corr.lcd }}" /></label>
    <label>Week Off<input type="number" name="week_off" value="{{ corr.week }}" /></label>
    <label>819 Station Off<input type="number" name="c819s" value="{{ corr.c819_station }}" /></label>
    <label>819 Dir/Color Off<input type="number" name="c819d" value="{{ corr.c819_dir }}" /></label>
    <div style="grid-column:1/-1;">
      <button type="submit">Apply Corrections</button>
    </div>
  </form>
</details>
<section class="panel" style="margin-bottom:1.5rem; padding:1rem 1.25rem;">
  <h2>Derive Auto-Corrections</h2>
  <p style="margin-top:.25rem; font-size:.9rem;">Provide any known calendar expressions (enter only what you know). Long Count must be full or 5-part (auto‑prepends baktun). Errors now show precise cause.</p>
  <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:.6rem;">
    <label style="font-weight:500;">Tzolkin<br><input id="ac_tz" placeholder="e.g. 11 Ik" /></label>
    <label style="font-weight:500;">Haab<br><input id="ac_h" placeholder="e.g. 0 Pop" /></label>
    <label style="font-weight:500;">G (0-8)<br><input id="ac_g" type="number" min="0" max="8" /></label>
    <label style="font-weight:500;">Long Count<br><input id="ac_lc" placeholder="13.0.0.0.0" /></label>
    <label style="font-weight:500;">Year Bearer<br><input id="ac_yb" placeholder="9 Ix" /></label>
    <label style="font-weight:500;">819 Station<br><input id="ac_819s" type="number" /></label>
    <label style="font-weight:500;">819 Value<br><input id="ac_819v" type="number" /></label>
    <label style="font-weight:500;">Dir Color<br><input id="ac_dc" placeholder="Este Rojo" /></label>
  </div>
  <div style="margin-top:.75rem;">
  <button type="button" onclick="runAutocorr()">Derive Offsets</button>
  <button type="button" onclick="fillAutocorrExample()">Example</button>
  </div>
  <pre id="ac_result" style="display:none; margin-top:1rem;"></pre>
</section>
<section class="panel" style="margin-bottom:1.5rem; padding:1rem 1.25rem;">
  <h2>Range Search</h2>
  <p style="margin-top:.25rem; font-size:.85rem;">Scan an inclusive JDN interval with optional filters. Returns first N matches (limit) in a lightweight table.</p>
  <form id="syncRangeForm" method="get" action="/" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:.6rem;">
    <label>Start<br><input type="number" name="r_start" value="{{ request.query_params.get('r_start','') }}" required></label>
    <label>End<br><input type="number" name="r_end" value="{{ request.query_params.get('r_end','') }}" required></label>
    <label>Tzolkin Val<br><input type="number" name="r_tzval" value="{{ request.query_params.get('r_tzval','') }}" min="1" max="13"></label>
    <label>Tzolkin Name<br><input name="r_tzname" placeholder="Imix" value="{{ request.query_params.get('r_tzname','') }}"></label>
    <label>Haab Day<br><input type="number" name="r_haab_day" value="{{ request.query_params.get('r_haab_day','') }}" min="0" max="19"></label>
    <label>Haab Month<br><input name="r_haab_month" placeholder="Pop" value="{{ request.query_params.get('r_haab_month','') }}"></label>
    <label>Year Bearer Name<br><input name="r_year_bearer_name" placeholder="Ix" value="{{ request.query_params.get('r_year_bearer_name','') }}"></label>
    <label>Dir/Color<br><input name="r_dir_color" placeholder="Este" value="{{ request.query_params.get('r_dir_color','') }}"></label>
    <label>Weekday (1-7)<br><input type="number" name="r_weekday" value="{{ request.query_params.get('r_weekday','') }}" min="1" max="7"></label>
    <label>Long Count Pattern<br><input name="r_long_count" placeholder="13.*.*.*.*.*" value="{{ request.query_params.get('r_long_count','') }}"></label>
    <label>Limit<br><input type="number" name="r_limit" value="{{ request.query_params.get('r_limit','') }}" min="0"></label>
    <label>Step<br><input type="number" name="r_step" value="{{ request.query_params.get('r_step','1') }}" min="1"></label>
    <label>Fields (csv)<br><input name="r_fields" placeholder="jdn,tzolkin_name" value="{{ request.query_params.get('r_fields','') }}"></label>
    <div style="grid-column:1/-1; display:flex; gap:.6rem;">
      <button type="submit">Search Range</button>
      <button type="button" onclick="this.form.querySelectorAll('input').forEach(i=>{ if(i.type!=='hidden') i.value=''; });">Clear</button>
  <button type="button" onclick="fillSyncRangeExample()">Example</button>
    </div>
  </form>
  {% if range %}
  <p style="font-size:.75rem; margin-top:.6rem; color:var(--color-text-soft);">Matches: {{ range.count }} (scanned {{ range.scanned }})</p>
    {% if range.rows %}
      <div style="overflow:auto; max-height:300px; border:1px solid var(--color-border); border-radius:6px;">
        <table class="alt-table" style="font-size:.78rem;">
          <thead style="position:sticky; top:0;">
            <tr>
              {% for f in range_fields %}<th>{{ f }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in range.rows %}
              <tr>
                {% for f in range_fields %}
                  <td style="font-family:ui-monospace,monospace;">
                    {% if f == 'jdn' and 'gregorian_date' in range_fields %}
                      {{ row['jdn'] }} ({{ row['gregorian_date'] }})
                    {% else %}
                      {{ row[f] }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p style="font-size:.75rem; color:#777;">No matches.</p>
    {% endif %}
  {% endif %}
  <p class="note" style="margin-top:.6rem;">Wildcard '*' allowed in Long Count pattern segments. Step reduces computations (e.g. 5 scans every 5th day). Empty limit scans entire span.</p>
</section>
<section class="panel" style="margin-bottom:1.5rem; padding:1rem 1.25rem;">
  <h2>Async Range Search (Cancelable)</h2>
  <p style="margin-top:.25rem; font-size:.8rem;">Launch a background job for large spans. Progress updates live; you can cancel anytime.</p>
  <form id="asyncRangeForm" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:.55rem; margin-bottom:.8rem;">
    <label>Start<br><input name="r_start" required></label>
    <label>End<br><input name="r_end" required></label>
    <label>Step<br><input name="r_step" value="1"></label>
    <label>Limit<br><input name="r_limit" placeholder="0=none"></label>
    <label>Tz Val<br><input name="r_tzval"></label>
    <label>Tz Name<br><input name="r_tzname" placeholder="Imix"></label>
    <label>Haab Day<br><input name="r_haab_day"></label>
    <label>Haab Month<br><input name="r_haab_month" placeholder="Pop"></label>
    <label>Year Bearer<br><input name="r_year_bearer_name" placeholder="Ix"></label>
    <label>Dir Color<br><input name="r_dir_color" placeholder="Este"></label>
    <label>Weekday<br><input name="r_weekday" placeholder="1-7"></label>
    <label>Long Count<br><input name="r_long_count" placeholder="13.*.*.*.*.*"></label>
    <label>Fields<br><input name="r_fields" placeholder="jdn,tzolkin_name"></label>
    <div style="grid-column:1/-1; display:flex; gap:.6rem;">
      <button type="submit">Search Range</button>
      <button type="button" onclick="this.form.reset()">Reset</button>
  <button type="button" onclick="fillAsyncExample()">Example</button>
    </div>
  </form>
  <div style="margin-bottom:.6rem; display:flex; gap:.6rem;">
    <button id="btnStopJob" type="button" class="danger" onclick="stopActiveJob()" disabled>Stop Current Job</button>
  </div>
  <div id="rangeJobBox" style="font-size:.75rem;">No job yet.</div>
</section>
{% if error %}<div class="error">Error: {{ error }}</div>{% endif %}
{% if comp %}
<section>
  <h2>Results</h2>
  <div class="grid">
    <div class="card"><h3>JDN / Gregorian</h3><div class="value">{{ comp.jdn }} ({{ comp.gregorian_date }})</div></div>
    <div class="card"><h3>Tzolkin</h3><div class="value">{{ comp.tzolkin_value }} {{ comp.tzolkin_name }}</div></div>
    <div class="card"><h3>Haab</h3><div class="value">{{ comp.haab_day }} {{ comp.haab_month_name }}</div></div>
    <div class="card"><h3>Long Count</h3><div class="value">{{ comp.long_count }}</div></div>
    <div class="card"><h3>Year Bearer</h3>
      <div class="value" title="Packed: 0x{{ '%04X' % comp.year_bearer_packed }}">{{ comp.year_bearer_value }} {{ comp.year_bearer_name }}</div>
    </div>
    <div class="card"><h3>819 Cycle</h3><div class="value">Station {{ comp.cycle819_station }} / {{ comp.cycle819_value }}</div></div>
    <div class="card"><h3>Dir Color</h3><div class="value">{{ comp.dir_color_str }}</div></div>
    <div class="card"><h3>Mercury</h3><div class="value">{{ '%.2f' % comp.mercury_synodic }} ({{ comp.mercury_index }})</div></div>
    <div class="card"><h3>Venus</h3><div class="value">{{ '%.2f' % comp.venus_synodic }} ({{ comp.venus_index }})</div></div>
  <div class="card"><h3>Mars</h3><div class="value">{{ '%.2f' % comp.mars_synodic }} ({{ comp.mars_index }})</div></div>
  <div class="card"><h3>Jupiter</h3><div class="value">{{ '%.2f' % comp.jupiter_synodic }} ({{ comp.jupiter_index }})</div></div>
  <div class="card"><h3>Saturn</h3><div class="value">{{ '%.2f' % comp.saturn_synodic }} ({{ comp.saturn_index }})</div></div>
  <div class="card"><h3>Uranus</h3><div class="value">{{ '%.2f' % comp.uranus_synodic }} ({{ comp.uranus_index }})</div></div>
  <div class="card"><h3>Neptune</h3><div class="value">{{ '%.2f' % comp.neptune_synodic }} ({{ comp.neptune_index }})</div></div>
  <div class="card"><h3>Pluto</h3><div class="value">{{ '%.2f' % comp.pluto_synodic }} ({{ comp.pluto_index }})</div></div>
    <div class="card"><h3>Maya Moon</h3><div class="value">{{ '%.2f' % comp.maya_moon_age }}</div></div>
    <div class="card"><h3>Abn Dist</h3><div class="value">{{ '%.2f' % comp.abnormal_distance }}</div></div>
    <div class="card"><h3>Eclipse?</h3><div class="value">{{ 'Yes' if comp.eclipse_possible else 'No' }}</div></div>
    <div class="card"><h3>Star Zodiac</h3><div class="value">{{ comp.star_zodiac_deg }}° {{ comp.star_zodiac_name }}</div></div>
    <div class="card"><h3>Earth Zodiac</h3><div class="value">{{ comp.earth_zodiac_deg }}° {{ comp.earth_zodiac_name }}</div></div>
  </div>
  <h3>Raw JSON</h3>
  <pre id="rawjson">{{ comp | tojson(indent=2) }}</pre>
</section>
{% endif %}
<footer>Generated by Pohualli Python port.</footer>
</div>
</body>
</html>
