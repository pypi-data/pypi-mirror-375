import argparse
import logging
import sys
from typing import Optional, List
from .prepdir_processor import PrepdirProcessor
from .prepdir_output_file import PrepdirOutputFile
from .config import __version__, load_config
from prepdir import prepdir_logging

logger = logging.getLogger(__name__)

def run(
    directory: str = ".",
    extensions: Optional[List[str]] = None,
    specific_files: Optional[List[str]] = None,
    output_file: Optional[str] = None,
    config_path: Optional[str] = None,
    scrub_hyphenated_uuids: Optional[bool] = None,
    scrub_hyphenless_uuids: Optional[bool] = None,
    replacement_uuid: Optional[str] = None,
    use_unique_placeholders: bool = False,
    ignore_exclusions: bool = False,
    include_prepdir_files: bool = False,
    quiet: bool = False,
    max_chars: Optional[int] = None,
) -> List[PrepdirOutputFile]:
    """
    Run prepdir to generate a formatted string of file contents.

    Args:
        directory: Starting directory path.
        extensions: List of file extensions to include (without the dot).
        specific_files: List of specific file paths to process.
        output_file: Path to save the output file.
        config_path: Path to custom config file.
        scrub_hyphenated_uuids: If True, scrub (hyphenated) UUIDs in file contents.
        scrub_hyphenless_uuids: If True, scrub hyphen-less UUIDs.
        replacement_uuid: UUID to replace detected UUIDs with when use_unique_placeholders is False.
        use_unique_placeholders: If True, replace UUIDs with unique placeholders.
        ignore_exclusions: If True, ignore exclusion lists.
        include_prepdir_files: If True, include files previously generated by prepdir.
        quiet: If True, suppress user-facing output.
        max_chars: Maximum characters per output file; split into parts if exceeded.

    Returns:
        List of PrepdirOutputFile instances containing the processed file contents and metadata.
    """
    if not quiet:
        print(f"Starting prepdir in {directory}")
    logger.info(f"Starting prepdir in {directory}")
    logger.debug("replacement_uuid is '%s', use_unique_placeholders is %s", replacement_uuid, use_unique_placeholders)

    # Load config to check defaults
    config = load_config("prepdir", config_path, quiet)

    processor = PrepdirProcessor(
        directory=directory,
        extensions=extensions if extensions is not None else config.get("DEFAULT_EXTENSIONS", []),
        specific_files=specific_files if specific_files is not None else config.get("SPECIFIC_FILES", []),
        output_file=output_file if output_file is not None else config.get("DEFAULT_OUTPUT_FILE", None),
        config_path=config_path,
        scrub_hyphenated_uuids=scrub_hyphenated_uuids if scrub_hyphenated_uuids is not None else config.get("SCRUB_HYPHENATED_UUIDS", True),
        scrub_hyphenless_uuids=scrub_hyphenless_uuids if scrub_hyphenless_uuids is not None else config.get("SCRUB_HYPHENLESS_UUIDS", True),
        replacement_uuid=replacement_uuid,
        use_unique_placeholders=use_unique_placeholders if use_unique_placeholders is not None else config.get("USE_UNIQUE_PLACEHOLDERS", False),
        ignore_exclusions=ignore_exclusions if ignore_exclusions is not None else config.get("IGNORE_EXCLUSIONS", False),
        include_prepdir_files=include_prepdir_files if include_prepdir_files is not None else config.get("INCLUDE_PREPDIR_FILES", False),
        quiet=quiet,
        max_chars=max_chars if max_chars is not None else config.get("MAX_CHARS", None),
    )

    outputs = processor.generate_output()

    if output_file:
        for output in outputs:
            processor.save_output(output, path=str(output.path))
            if not quiet:
                print(f"Saved output to {output.path}")
    else:
        for output in outputs:
            print(output.content)

    return outputs

def main():
    """Command-line interface for prepdir."""
    parser = argparse.ArgumentParser(description="Directory traversal utility to prepare project contents for review.")
    parser.add_argument(
        "directory",
        nargs="?",
        default=".",
        help="Directory to process (default: current directory)",
    )
    parser.add_argument(
        "-e",
        "--extensions",
        nargs="*",
        help="File extensions to include (e.g., py txt)",
    )
    parser.add_argument(
        "-f",
        "--files",
        nargs="*",
        help="Specific files to process (relative or absolute paths)",
    )
    parser.add_argument(
        "-o",
        "--output",
        help="Output file name (default: prepped_dir.txt)",
        default="prepped_dir.txt",
    )
    parser.add_argument(
        "-m",
        "--max-chars",
        type=int,
        help="Maximum characters per output file; split into parts if exceeded",
    )
    parser.add_argument(
        "--init",
        action="store_true",
        help="Initialize a local config.yaml",
    )
    parser.add_argument(
        "--config",
        help="Path to a custom config file",
    )
    parser.add_argument(
        "--force",
        action="store_true",
        help="Overwrite existing config file with --init",
    )
    parser.add_argument(
        "--no-scrub-uuids",
        action="store_true",
        help="Disable all UUID scrubbing",
    )
    parser.add_argument(
        "--no-scrub-hyphenated-uuids",
        action="store_true",
        help="Disable hyphenated UUID scrubbing",
    )
    parser.add_argument(
        "--no-scrub-hyphenless-uuids",
        action="store_true",
        help="Disable hyphen-less UUID scrubbing",
    )
    parser.add_argument(
        "--replacement-uuid",
        help="Custom UUID to replace detected UUIDs",
    )
    parser.add_argument(
        "--use-unique-placeholders",
        action="store_true",
        help="Replace UUIDs with unique placeholders (e.g., PREPDIR_UUID_PLACEHOLDER_n)",
    )
    parser.add_argument(
        "--all",
        action="store_true",
        help="Include all files, ignoring exclusions",
    )
    parser.add_argument(
        "--include-prepdir-files",
        action="store_true",
        help="Include prepdir-generated files",
    )
    parser.add_argument(
        "-v",
        "--verbose",
        action="count",
        default=0,
        help="Increase verbosity: -v for INFO, -vv for DEBUG",
    )
    parser.add_argument(
        "-q",
        "--quiet",
        action="store_true",
        help="Suppress user-facing output",
    )
    parser.add_argument(
        "--version",
        action="version",
        help="Show version and exit",
        version=f"prepdir {__version__}",
    )

    args = parser.parse_args()

    # Determine logging level
    LEVEL_MAP = {0: logging.WARNING, 1: logging.INFO, 2: logging.DEBUG}
    logging_level = LEVEL_MAP.get(args.verbose, logging.WARNING) if args.verbose > 0 else logging.WARNING

    # Configure logging for the 'prepdir' logger
    prepdir_logger = logging.getLogger('prepdir')
    prepdir_logging.configure_logging(prepdir_logger, level=logging_level)
    logging.getLogger("dynaconf").setLevel(logging.CRITICAL)  # Suppress dynaconf logging
    logger.debug("args are: %s", args)

    if args.init:
        try:
            PrepdirProcessor.init_config(config_path=args.config, force=args.force, quiet=args.quiet)
        except SystemExit as e:
            sys.exit(e.code)
        return

    # Initialize scrub variables to None to respect config defaults
    scrub_hyphenated_uuids = None
    scrub_hyphenless_uuids = None

    # Override only if specific flags are provided
    if args.no_scrub_uuids:
        scrub_hyphenated_uuids = False
        scrub_hyphenless_uuids = False
    if args.no_scrub_hyphenated_uuids:
        scrub_hyphenated_uuids = False
    if args.no_scrub_hyphenless_uuids:
        scrub_hyphenless_uuids = False

    try:
        outputs = run(
            directory=args.directory,
            extensions=args.extensions,
            specific_files=args.files,
            output_file=args.output,
            config_path=args.config,
            scrub_hyphenated_uuids=scrub_hyphenated_uuids,
            scrub_hyphenless_uuids=scrub_hyphenless_uuids,
            replacement_uuid=args.replacement_uuid,
            use_unique_placeholders=args.use_unique_placeholders,
            ignore_exclusions=args.all,
            include_prepdir_files=args.include_prepdir_files,
            quiet=args.quiet,
            max_chars=args.max_chars,
        )
    except ValueError as e:
        print(f"Error: {str(e)}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Unexpected error: {str(e)}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()