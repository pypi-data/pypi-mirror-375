CLOSE

;####################################################
; Autogenerated Homing PLC for GeoBrick, DO NOT MODIFY
; Group 2:
;####################################################

; Use a different timer for each PLC
#define timer             i(5111+(13&30)*50+13%2)
; Make timer more readable
#define MilliSeconds      * 8388608/i10

; Homing State P Variable
#define HomingState       P1300
#define StateIdle         0
#define StateConfiguring  1
#define StateMoveNeg      2
#define StateMovePos      3
#define StateHoming       4
#define StatePostHomeMove 5
#define StateAligning     6
#define StateDone         7
#define StateFastSearch   8
#define StateFastRetrace  9
#define StatePreHomeMove  10
HomingState = StateIdle

; Homing Status P Variable
#define HomingStatus      P1301
#define StatusDone        0
#define StatusHoming      1
#define StatusAborted     2
#define StatusTimeout     3
#define StatusFFErr       4
#define StatusLimit       5
#define StatusIncomplete  6
#define StatusInvalid     7
#define StatusPaused      8
#define StatusDebugHoming 9
HomingStatus = StatusDone

; Homing Group P Variable
#define HomingGroup       P1302
HomingGroup = 0

; Homing Group Backup P Variable
#define HomingBackupGroup P1303
HomingBackupGroup = 0

OPEN PLC13 CLEAR

if (HomingStatus != StatusHoming)
and (HomingStatus != StatusDebugHoming)
    HomingStatus = StatusHoming
endif

;---- Configuring State ----
HomingState=StateConfiguring
;Save the Homing group to px03
HomingBackupGroup=HomingGroup
;Save high soft limits to P variables px04..x19
P1304=i113 P1305=i213
;Save the low soft limits to P variables px20..x35
P1320=i114 P1321=i214
;Save the home capture flags to P variables px36..x51
MSR8,i912,P1337 P1336=i7012
;If any are zero then there is probably a macro error
if (P1337=0)
    HomingStatus=StatusInvalid
endif
;Store 'not flag' to use in moving off a flag in P variables px52..x67
P1352=P1336^$C P1353=P1337^$C
;Save the limit flags to P variables px68..x83
P1368=i124 P1369=i224
;Save the current position to P variables px84..x99
P1384=M162 P1385=M262
;Clear the soft limits
i113=0 i213=0
i114=0 i214=0

if (HomingBackupGroup = 1 or HomingBackupGroup = 2)
and (HomingStatus = StatusHoming or HomingStatus = StatusDebugHoming)
    HomingGroup=2

    ;Clear home flags
    m145=0 m245=0
endif

;---- Done ----
if (HomingStatus = StatusHoming or HomingStatus = StatusDebugHoming)
    ;If we've got this far without failing, set status and state done
    HomingStatus=StatusDone
    HomingState=StateDone
    ;Restore the homing group from px03
    HomingGroup=HomingBackupGroup
endif

;---- Tidy Up ----
;Stop all motors if they don't have a following error
if (m142=0)
    cmd "#1J/"
endif
if (m242=0)
    cmd "#2J/"
endif
;Restore the high soft limits from P variables px04..x19
i113=P1304 i213=P1305
;Restore the low soft limits from P variables px20..x35
i114=P1320 i214=P1321
;Restore the home capture flags from P variables px36..x51
MSW8,i912,P1337 i7012=P1336
;Restore the limit flags to P variables px68..x83
i124=P1368 i224=P1369

DISABLE PLC13
CLOSE
