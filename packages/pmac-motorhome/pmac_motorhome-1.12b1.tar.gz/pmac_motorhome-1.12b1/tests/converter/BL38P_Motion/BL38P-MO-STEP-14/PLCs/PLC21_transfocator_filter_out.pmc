;####################################################
; DO NOT MODIFY: File created from src/PLC21_transfocator_filter_out.psub
;####################################################

;FILTER REMOVE PLC
;ASSUMPTIONS: POS DIRECTION PUSHES THE FILTER OUT (DOWN)
;			HOME IS -967CTS FROM REFERENCE MARK
;REV3:		ROCKER STILL IN OPEN LOOP BUT LOGGING ENCODER POSITION ON AXIS 8 TO P5000+FILTER NO
;REV4:		ROCKER NOW IN CLOSED LOOP, ONLY 1 POSITION FOR FILTER IN (-1508 FROM REFERENCE)
;			IF ROCKER TIMES OUT IT'S PROBABLY DUE TO THE CLUTCH BECOMING DISENGAGED. TO GET AROUND
;			THIS AN "o" COMMAND IS ISSUED UNTIL THE HOME SWITCH IS SEEN.
;			TIMED_OUT_STATUS NOW HAS STATE 2 IF THE "o" COMMAND FAILS TO GET TO THE HOME SWITCH.

; Macros (and example values):
; - PLC_NO 		= 21  PLC Number for this PLC, e.g 21
; - MAIN_PLC_NO 	= 20  PLC Number for the main PLC, e.g 20
; - ROCKER 		= 6  Axisnum for rocker axis, e.g. 6
; - OUT_TIME 		= 50  How long the rocker dwells in the "out" position, e.g. 50
; - HOME_TIME 		= 50  How long the rocker dwelsl in the "home" position, e.g. 50
; - TIMEOUT 		= 5000  Timeout period for jams in ms, e.g 5000
; - FILTER_OUT_POS 	= 430  Position the rocker drives to to fire out, e.g 547

#DEFINE PLC_NO	21
#DEFINE MAIN_PLC_NO	20

#DEFINE ROCKER	6
#DEFINE ROCKER_IN_SWITCH	M(100*ROCKER + 21)
#DEFINE ROCKER_1_HOME M(100*ROCKER + 20)
#DEFINE JOG_PRESET_VARIABLE M(100*ROCKER + 72)
#DEFINE IN_POSITION M(100*ROCKER + 40)

#DEFINE JOG_AXIS_POS	&COMMAND"J+"
#DEFINE JOG_AXIS_NEG	&COMMAND"J-"
#DEFINE STOP_AXIS	&COMMAND"J/"
#DEFINE JOG_PRESET	&COMMAND"J^*"
#DEFINE KILL_AXIS	&COMMAND"K"
#DEFINE JOG_TO_PRESET	&COMMAND"J=*"
#DEFINE HOME_AXIS	&COMMAND"HM"
#DEFINE JOG_TO_TRIGGER_POS	&COMMAND"J^2400^0"
#DEFINE JOG_TO_TRIGGER_NEG	&COMMAND"J:-2400^0"
#DEFINE POSITIVE_OPEN_LOOP_MOVE	&COMMAND"o0.5"
#DEFINE NEGATIVE_OPEN_LOOP_MOVE	&COMMAND"o-0.5"

#DEFINE TIMER	I(5111+(21&30)*50+21%2)
#DEFINE MILLISECONDS	* 8388608/i10
#DEFINE ROCKER_OUT_TIME 50
#DEFINE ROCKER_HOME_TIME 50
#DEFINE TIMEOUT 5000
#DEFINE OPEN_LOOP_TIMEOUT	4000

#DEFINE JOG_VELOCITY I(100*ROCKER +22)

#DEFINE PLC_RUNNING	P(100*PLC_NO +10)
#DEFINE TIMED_OUT P(100*PLC_NO +11)
#DEFINE DEBOUNCE_LATCH	P(100*PLC_NO +12)
#DEFINE VELOCITY_STORE P(100*PLC_NO +16)
#DEFINE TIMED_OUT_STATUS P(100*PLC_NO +17)
#DEFINE SLOW_VELOCITY 4

#DEFINE FILTER_OUT_POSITION P(100*PLC_NO +18)

#DEFINE CURRENT_FILTER_READBACK	P(100*MAIN_PLC_NO + 42)

FILTER_OUT_POSITION = 430


OPEN PLC PLC_NO
CLEAR

PLC_RUNNING = 1
TIMED_OUT = 0
TIMED_OUT_STATUS = 0

;SET UP OVER DRIVE AMOUNT
JOG_PRESET_VARIABLE = FILTER_OUT_POSITION

;JOG AXIS TO PREDEFINED POSITION
ADDRESS#ROCKER
JOG_TO_PRESET				
WHILE(IN_POSITION = 1)
ENDWHILE

TIMER = TIMEOUT MILLISECONDS						
WHILE(IN_POSITION = 0)AND(TIMER > 0)
ENDWHILE

IF(TIMER < 0)OR(TIMER = 0)
	TIMED_OUT = 1
	TIMED_OUT_STATUS = 1
ENDIF

IF(TIMED_OUT = 0)
	;DWELL
	TIMER = ROCKER_OUT_TIME MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
ELSE
	;IF THE AXIS DID TIME OUT IT PROBABLY HAS BECOME DISENGAED AND WILL REQUIRE AN OPEN LOOP MOVE
	ADDRESS#ROCKER
	KILL_AXIS
	TIMER = 10 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
	ADDRESS#ROCKER
	NEGATIVE_OPEN_LOOP_MOVE
	
	TIMER = OPEN_LOOP_TIMEOUT MILLISECONDS
	WHILE(ROCKER_1_HOME = 0)AND(TIMER > 0)
	ENDWHILE
	
	ADDRESS#ROCKER
	KILL_AXIS
	
	IF(TIMER < 0)OR(TIMER = 0)
		TIMED_OUT_STATUS = 2
	ENDIF

ENDIF

IF(TIMED_OUT_STATUS < 2)
	;JOG POSITIVE UNTIL ROCKER IS IN ITS HOME POSITION AND TRANSLATION IS FREE TO MOVE
	JOG_PRESET_VARIABLE = 0
	ADDRESS#ROCKER
	JOG_TO_PRESET									
	;TIMER = 20 MILLISECONDS				
	;WHILE(TIMER > 0)
	;ENDWHILE
	WHILE(IN_POSITION = 1)
	ENDWHILE

	
	TIMER = TIMEOUT MILLISECONDS						
	WHILE(IN_POSITION = 0)AND(TIMER > 0)
	ENDWHILE

	IF(TIMER < 0)OR(TIMER = 0)
		TIMED_OUT = 1
		TIMED_OUT_STATUS = 3
	ENDIF
	
	IF(TIMED_OUT_STATUS = 3)
		;IF THE AXIS DID TIME OUT IT PROBABLY HAS BECOME DISENGAED AND WILL REQUIRE AN OPEN LOOP MOVE
		ADDRESS#ROCKER
		KILL_AXIS
		TIMER = 10 MILLISECONDS				
		WHILE(TIMER > 0)
		ENDWHILE
		ADDRESS#ROCKER
		NEGATIVE_OPEN_LOOP_MOVE
		
		TIMER = OPEN_LOOP_TIMEOUT MILLISECONDS
		WHILE(ROCKER_1_HOME = 0)AND(TIMER > 0)
		ENDWHILE
	
		ADDRESS#ROCKER
		KILL_AXIS
	
		IF(TIMER < 0)OR(TIMER = 0)
			TIMED_OUT_STATUS = 4
		ENDIF
	ENDIF
	
	TIMER = 10 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
										
	TIMER = ROCKER_HOME_TIME MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
ENDIF

TIMER = 10 MILLISECONDS				
WHILE(TIMER > 0)
ENDWHILE
IF(TIMED_OUT = 0)
	PLC_RUNNING = 0
ELSE
	PLC_RUNNING = -1
ENDIF

DISABLE PLC PLC_NO
CLOSE
