# Auto-generated by Fixit. Do not edit by hand.
import httpx
import pytest
from fixit.core.config import read_config

cfg = read_config()
BASE_URL = (cfg.base_url if cfg else "{{ test_plan.base_url }}").rstrip("/")

TEST_CASES = [
{% for tc in test_plan.test_cases %}
    {
        "id": "{{ tc.id }}",
        "name": "{{ tc.name.replace('"', '\\"') }}",
        "method": "{{ tc.method }}",
        "path": "{{ tc.path }}",
        "expected_status": {{ tc.expected_status }},
        "headers": {{ tc.headers }},
        "path_params": {{ tc.path_params }},
        "query_params": {{ tc.query_params }},
        "request_body": {{ 'None' if tc.request_body is none else tc.request_body }},
    },
{% endfor %}
]

@pytest.mark.parametrize("case", TEST_CASES, ids=[c["id"] for c in TEST_CASES])
def test_endpoint(case):
    path = case["path"]
    # format path parameters: OpenAPI style /users/{id}
    if case.get("path_params"):
        try:
            path = path.format(**case["path_params"])
        except Exception:
            pass
    url = BASE_URL + path
    headers = dict(case.get("headers") or {})
    params = case.get("query_params") or None
    data = case.get("request_body", None)
    method = case["method"].lower()

    with httpx.Client(follow_redirects=True, timeout=10.0) as client:
        resp = client.request(method, url, json=data, params=params, headers=headers)

    try:
        assert resp.status_code == case["expected_status"], (
            f"{case['id']}: {method.upper()} {url} "
            f"got {resp.status_code}, body={resp.text[:500]!r}"
        )
    except AssertionError:
        import json, pathlib
        ws = pathlib.Path(".fixit"); ws.mkdir(exist_ok=True)
        (ws / "reports").mkdir(exist_ok=True)
        failure = {
            "test_id": case["id"],
            "endpoint_id": f"{case['method']} {case['path']}",
            "method": case["method"],
            "path": case["path"],
            "expected_status": case["expected_status"],
            "actual_status": resp.status_code,
            "request": {
                "headers": {k: ("<redacted>" if k.lower()=="authorization" else v) for k,v in (headers or {}).items()},
                "path_params": case.get("path_params"),
                "query_params": case.get("query_params"),
                "body": case.get("request_body"),
            },
            "response": {
                "headers": dict(resp.headers),
                "body_text": resp.text[:400],
            },
            "framework": "{{ test_plan.framework }}"
        }
        with open(ws / "reports" / "failures.jsonl", "a", encoding="utf-8") as f:
            f.write(json.dumps(failure, ensure_ascii=False) + "\n")
        raise