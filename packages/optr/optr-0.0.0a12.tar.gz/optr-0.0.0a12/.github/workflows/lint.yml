name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:

permissions:
  contents: read
  packages: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: ghcr.io/${{ github.repository }}:ci

    steps:
    - uses: actions/checkout@v5

    - name: Set up UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    # - name: Cache VirtualEnv
    #   id: venv
    #   uses: actions/cache@v4
    #   with:
    #     path: .venv
    #     key: venv-${{ runner.os }}-${{ hashFiles('uv.lock') }}

    - name: Install Dependencies
      if: steps.venv.outputs.cache-hit != 'true'
      run: uv sync --group dev --all-extras --frozen

    - name: Cache Analyzer
      uses: actions/cache@v4
      with:
        path: |
          .mypy_cache
          .ruff_cache
        key: lintcache-${{ runner.os }}-${{ github.ref }}
        restore-keys: |
          lintcache-${{ runner.os }}-

    - name: Check Formatting
      run: uv run ruff format --check

    - name: Run Linter
      run: uv run ruff check --output-format=github

    - name: Run Type Checker
      run: uv run mypy src
