name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint-and-syntax:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install minimal deps for linting
      run: |
        python -m pip install --upgrade pip
        pip install ruff pyflakes pylint
    
    - name: Check Python syntax
      run: |
        find src -name "*.py" -type f | xargs python -m py_compile
        echo "✓ Syntax check passed"
    
    - name: Run ruff (fast linter)
      run: |
        ruff check src/ --select E,F,W --ignore E501,E402,F401
    
    - name: Check for common errors with pyflakes
      run: |
        pyflakes src/ || true
    
    - name: Check version file
      run: |
        export PYTHONPATH=src
        python -c "from witticism import __version__; print(f'Version: {__version__}')"
    
    - name: Validate pyproject.toml
      run: |
        python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb')); print('✓ pyproject.toml is valid')"
    
    - name: Check for security issues
      run: |
        pip install bandit
        bandit -r src/ -ll  # Only show medium/high severity
  
  test:
    runs-on: ubuntu-latest
    name: Run Unit Tests
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install minimal test dependencies
      run: |
        python -m pip install --upgrade pip
        # Install only non-GPU dependencies needed for tests
        pip install platformdirs
    
    - name: Run all unit tests
      run: |
        # Discover and run all tests in the tests directory
        python -m unittest discover -s tests -p "test_*.py" -v
    
    - name: Test summary
      if: always()
      run: |
        echo "✓ Unit test run completed"
        echo "Test discovery will automatically find:"
        echo "  - All test_*.py files in tests/"
        echo "  - All TestCase classes"
        echo "  - All test_* methods"