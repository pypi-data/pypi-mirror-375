import io
import base64
from methnum import course
course.log.setLevel("INFO")
course.forge.login()
student_group = "CandidatsLibres"
assignment_name = "L1/Seance1"

assignment = course.assignment(assignment_name, student_group=student_group)
submissions = assignment.submissions()

content = b"""# Autogenerated by methnum
image: gitlab.dsi.universite-paris-saclay.fr:5005/methnum/computerlab:master

variables:
  ASSIGNMENT: Seance1
  STUDENT: $CI_PROJECT_ROOT_NAMESPACE

autograde:
  script:
    # - source activate methnum
    # skip student_autograde for instructor release
    - if [ "$STUDENT" == "MethNum" ]; then exit 0; else echo $STUDENT; fi
    - STUDENT=`echo $STUDENT | sed -e 's/_travo//;s/_/./'`
    - methnum student_autograde $ASSIGNMENT $STUDENT
  artifacts:
    paths:
      - autograded
      - feedback
    # reports:
    #   junit: feedback/scores.xml
"""
content = base64.b64encode(content)

for submission in submissions:
    repo = submission.repo
    print(repo.web_url)
    repo.ensure_file(".gitlab-ci.yml", content=content, encoding='base64', commit_message="Errata: correction automatique: fichier gitlab_ci mise Ã  jour")