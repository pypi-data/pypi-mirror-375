;####################################################
; DO NOT MODIFY: File created from src/PLC23_transfocator_homing.psub
;####################################################

;HOMING PLC
;ASSUMPTIONS:	ROCKER POS DIRECTION PUSHES THE FILTER IN (UP)
;				TRANSLATION POS DIRECTION MOVES ROCKER AWAY FROM MOTOR
;				TRANSLATION SET TO HOME ON FALLING EDGE OF NEGATIVE LIMIT
;				TRANSLATION HOMING SPEED IS POSITIVE
;
;MODIFIED VERSION OF THE HOMING ROUTINE SPECIFICALLY FOR BL22I TO USE THE OPTICAL ROCKER SWITCH AND 
;NO LIMIT SWITCHES
;I7112=11
;I7113=2
;I7122=1

; Macros (and example values):
; - PLC_NO	 	= 23  PLC Number for this PLC, e.g 23
; - MAIN_PLC_NO 	= 20  PLC Number for the main PLC, e.g 20
; - TRANS 		= 5  Axisnum for translation axis, e.g 5
; - ROCKER 		= 6  Axisnum for rocker axis, e.g. 6
; - ROCKER_TIMEOUT 	= 10000  Timeout period for jams in ms, e.g 10000
; - TRANSLATION_TIMEOUT	= 60000  Timeout period for jams in ms, e.g 60000
; - IN_TIME 		= 50  How long the rocker dwells in the "in" position, e.g. 50
; - OUT_TIME 		= 50  How long the rocker dwells in the "out" position, e.g. 50
; - HOME_TIME 		= 200  How long the rocker dwelsl in the "home" position, e.g. 200
; - ROCKER_SLOW_VEL 	= 0.1  Slow velocity for homing rocker, e.g. 0.1

#DEFINE PLC_NO	23

#DEFINE TRANSLATION	5
#DEFINE	ROCKER	6

;GENERIC AXIS COMMANDS
#DEFINE JOG_AXIS_POS	&COMMAND"J+"
#DEFINE JOG_AXIS_NEG	&COMMAND"J-"
#DEFINE STOP_AXIS	&COMMAND"J/"
#DEFINE JOG_PRESET	&COMMAND"J^*"
#DEFINE KILL_AXIS	&COMMAND"K"
#DEFINE JOG_TO_PRESET	&COMMAND"J=*"
#DEFINE HOME_AXIS	&COMMAND"HM"
#DEFINE JOG_TO_TRIGGER_HM	&COMMAND"J:700^100"
#DEFINE HOMEZ_AXIS	&COMMAND"HMZ"
#DEFINE JOG_TO_TRIGGER_POS	&COMMAND"J^2400^0"
#DEFINE JOG_TO_TRIGGER_NEG	&COMMAND"J:-2400^0"

;ROCKER VARIABLES
#DEFINE ROCKER_1_NOT_HOME M(100*ROCKER + 20)
#DEFINE ROCKER_IN_SWITCH	M(100*ROCKER + 21)
#DEFINE ROCKER_OUT_SWITCH	M(100*ROCKER + 22)
#DEFINE ROCKER_LIMIT_CONTROL	I(100*ROCKER+24)
#DEFINE ROCKER_HOME_OFFSET	I(100*ROCKER+26)
#DEFINE ROCKER_SLOW_VELOCITY  P(100*PLC_NO +18)
#DEFINE ROCKER_VELOCITY_STORE P(100*PLC_NO +16)
#DEFINE ROCKER_IN_POSITION M(100*ROCKER + 40)
#DEFINE ROCKER_JOG_VELOCITY I(100*ROCKER +22)
#DEFINE ROCKER_HOMED M(100*ROCKER + 45)
#DEFINE ROCKER_FFE M(100*ROCKER + 42)
#DEFINE ROCKER_FFE_LIM I(100*ROCKER + 11)
#DEFINE ROCKER_PRESET M(100*ROCKER + 72)

;TRANSLATION VARIABLES
#DEFINE TRANSLATION_SLOW_SPEED	10
#DEFINE TRANSLATION_SPEED_STORE	P(100*PLC_NO + 1)
#DEFINE TRANSLATION_SPEED	I(100*TRANSLATION + 22)
#DEFINE TRANSLATION_IN_POS	M(100 * TRANSLATION + 40)
#DEFINE TRANSLATION_HOMED	M(100 * TRANSLATION + 45)
#DEFINE TRANSLATION_NLIM	M(100 * TRANSLATION + 22)

;INVOCATION BITS
#DEFINE HOME_IN_NEG_DIR	P(100*PLC_NO + 10)
#DEFINE HOME_IN_POS_DIR	P(100*PLC_NO + 11)
#DEFINE MOVE_TO_POS_LIMIT	P(100*PLC_NO + 12)


#DEFINE PLC_RUNNING	P(100*PLC_NO +13)
#DEFINE TIMED_OUT P(100*PLC_NO +14)
#DEFINE MOVE_ROCKER_OUT	P(100*PLC_NO +15)
#DEFINE FFE_LIMIT_STORE	P(100*PLC_NO +16)

#DEFINE HOME_OFFSET_STORE	P(100*PLC_NO +17)

#DEFINE MAIN_PLC_NO	20
#DEFINE ABORT	P(100*MAIN_PLC_NO+8)

;TIMER 
#DEFINE TIMER	I(5111+(10&30)*50+10%2)
#DEFINE MILLISECONDS	* 8388608/i10
#DEFINE ROCKER_IN_TIME 50
#DEFINE ROCKER_OUT_TIME 50
#DEFINE ROCKER_HOME_TIME 200
#DEFINE TRANSLATION_TIMEOUT	60000
#DEFINE ROCKER_TIMEOUT 10000



#DEFINE NUMBER_OF_FILTERS_COUNTER    P(100*MAIN_PLC_NO + 16)
#DEFINE FIRST_FILTER                 P(100*MAIN_PLC_NO + 17)
#DEFINE NUMBER_OF_FILTERS_STORE      P(100*MAIN_PLC_NO + 18)
#DEFINE CURRENT_FILTER_READBACK      P(100*MAIN_PLC_NO + 42)

ROCKER_SLOW_VELOCITY = 0.1

OPEN PLC PLC_NO 
CLEAR

PLC_RUNNING = 1

TIMED_OUT = 0

;*********************************************************
;HOME ROCKER ON PHYSICAL HOME SWITCH
;*********************************************************

IF(ROCKER_1_NOT_HOME = 1)
	ROCKER_VELOCITY_STORE = ROCKER_JOG_VELOCITY
	ROCKER_JOG_VELOCITY = ROCKER_SLOW_VELOCITY
	FFE_LIMIT_STORE = ROCKER_FFE_LIM
	ROCKER_FFE_LIM = 64
	;ROCKER_LIMIT_CONTROL = $800401
	ROCKER_PRESET = -800
	ADDRESS#ROCKER
	JOG_PRESET
	
	TIMER = 100 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
	
	WHILE(ROCKER_FFE = 0 AND ROCKER_IN_POSITION = 0 )
	ENDWHILE

	ROCKER_JOG_VELOCITY = ROCKER_VELOCITY_STORE

	HOME_OFFSET_STORE = ROCKER_HOME_OFFSET
	ROCKER_HOME_OFFSET = 800

	ROCKER_FFE_LIM = 16000

	ADDRESS#ROCKER
	JOG_TO_TRIGGER_HM
	TIMER = 100 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE

	TIMER = ROCKER_TIMEOUT MILLISECONDS
	WHILE(ROCKER_1_NOT_HOME = 1 AND TIMER > 0)
	ENDWHILE

	;IF ROCKER TIMED OUT DURING HOMING
	IF(TIMER = 0)
		ADDRESS#ROCKER
		STOP_AXIS
		TIMED_OUT = 1
	ENDIF

	;ROCKER_LIMIT_CONTROL = $820401
	ROCKER_FFE_LIM = FFE_LIMIT_STORE
	TIMER = 1000 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
	ROCKER_HOME_OFFSET = HOME_OFFSET_STORE
ENDIF
;*********************************************************




IF(TIMED_OUT = 0)

	TIMER = TRANSLATION_TIMEOUT MILLISECONDS
			
	;JOG AXIS TO NEGATIVE LIMIT		
	ADDRESS#TRANSLATION
	JOG_AXIS_NEG

	WHILE(TRANSLATION_NLIM = 0 AND TIMER > 0)
	ENDWHILE

	IF(TIMER > 0)
		WHILE(TRANSLATION_IN_POS = 0)
		ENDWHILE

		;HOME AXIS ON FALLING EDGE OF NEGATIVE LIMIT
		ADDRESS#TRANSLATION
		HOME_AXIS

		WHILE(TRANSLATION_HOMED = 0)
		ENDWHILE

		TIMER = 1000 MILLISECONDS				
		WHILE(TIMER > 0)
		ENDWHILE
	ELSE
			ADDRESS#TRANSLATION
			STOP_AXIS
		TIMED_OUT = 1
	ENDIF
ENDIF

IF(TIMED_OUT = 0)
	I7122 = 1	;SET SELECTOR TO HOME ON REFERENCE MARK

	ADDRESS#ROCKER
	HOME_AXIS
	TIMER = 100 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE

	TIMER = ROCKER_TIMEOUT MILLISECONDS
	WHILE(ROCKER_HOMED = 0 AND TIMER > 0)
	ENDWHILE

	;IF ROCKER TIMED OUT DURING HOMING
	IF(TIMER = 0)
		ADDRESS#ROCKER
		STOP_AXIS
		TIMED_OUT = 1
    ELSE
        CURRENT_FILTER_READBACK = 0
        NUMBER_OF_FILTERS_COUNTER = 0
        FIRST_FILTER = 0
        NUMBER_OF_FILTERS_STORE = 0
	ENDIF

	TIMER = 1000 MILLISECONDS				
	WHILE(TIMER > 0)
	ENDWHILE
	P2350 = 1
	I7122 = 10	;SET SELECTOR TO HOME OR FLAG (HOME FLAG)
ENDIF




ABORT=0
PLC_RUNNING = 0

DISABLE PLC PLC_NO

CLOSE
