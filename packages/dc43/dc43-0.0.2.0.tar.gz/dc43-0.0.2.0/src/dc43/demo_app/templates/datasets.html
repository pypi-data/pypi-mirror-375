{% extends "base.html" %}
{% block content %}
<h1>Pipeline Runs</h1>
{% if message %}<div class="alert alert-success">{{ message }}</div>{% endif %}
{% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
<form class="row g-3 mb-4" method="post" action="/pipeline/run" id="run-form">
  <div class="col-md-4">
    <label class="form-label">Scenario</label>
    <select class="form-select" name="scenario" id="scenario">
      <option value="">Select a scenario</option>
      {% for key, sc in scenarios.items() %}
      <option value="{{ key }}">{{ sc.label }}</option>
      {% endfor %}
    </select>
    <div class="form-text" id="scenario-desc"></div>
  </div>
  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary w-100" type="submit" id="run-btn">Run Pipeline</button>
  </div>
</form>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Contract ID</th>
        <th>Contract Version</th>
        <th>Draft Version</th>
        <th>Dataset</th>
        <th>Version</th>
        <th>Run Type</th>
        <th>Status</th>
        <th>Violations</th>
        <th>DQ Details</th>
      </tr>
    </thead>
    <tbody>
    {% for r in records %}
      <tr>
        <td><a href="/contracts/{{ r.contract_id }}">{{ r.contract_id }}</a></td>
        <td><a href="/contracts/{{ r.contract_id }}/{{ r.contract_version }}">{{ r.contract_version }}</a></td>
        <td>
          {% if r.draft_contract_version %}
            <a href="/contracts/{{ r.contract_id }}/{{ r.draft_contract_version }}">{{ r.draft_contract_version }}</a>
          {% endif %}
        </td>
        <td>{{ r.dataset_name }}</td>
        <td><a href="/datasets/{{ r.dataset_name }}/{{ r.dataset_version }}">{{ r.dataset_version }}</a></td>
        <td>{{ r.run_type }}</td>
        <td>
          {{ r.status }}
          {% if r.dq_details.get('output', {}).get('warnings') %}
            <span class="text-warning ms-1" title="Schema warnings">&#9888;</span>
          {% endif %}
        </td>
        <td>
          {% set fails = r.dq_details.get('output', {}).get('failed_expectations', {}) %}
          {% if fails %}
            {% for key, info in fails.items() %}
              <div>{{ key }} ({{ info.count }})</div>
            {% endfor %}
          {% else %}
            {{ r.violations }}
          {% endif %}
        </td>
        <td>
          <details>
            <summary>Show</summary>
            <div class="accordion mt-2" id="dq-{{ loop.index }}">
              <div class="accordion-item">
                <h2 class="accordion-header" id="dq-input-{{ loop.index }}-h">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dq-input-{{ loop.index }}">Input</button>
                </h2>
                <div id="dq-input-{{ loop.index }}" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    {% for key in ['orders', 'customers'] %}
                      {% if r.dq_details.get(key) %}
                      <h6 class="text-capitalize">{{ key }}</h6>
                      <pre class="small">{{ r.dq_details.get(key) | tojson(indent=2) }}</pre>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="dq-output-{{ loop.index }}-h">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dq-output-{{ loop.index }}">Output</button>
                </h2>
                <div id="dq-output-{{ loop.index }}" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    {% set fails = r.dq_details.get('output', {}).get('failed_expectations', {}) %}
                    {% if fails %}
                      {% for key, info in fails.items() %}
                        <div class="mb-2"><strong>{{ key }}</strong>: <code>{{ info.expression }}</code> ({{ info.count }})
                        {% if info.examples %}
                          <details class="small"><summary>Examples</summary><pre class="small mb-0">{{ info.examples | tojson(indent=2) }}</pre></details>
                        {% endif %}
                        </div>
                      {% endfor %}
                    {% endif %}
                    <pre class="small mb-0">{{ r.dq_details.get('output') | tojson(indent=2) }}</pre>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
<script>
    const scenarios = {{ scenarios | tojson }};
    const scenarioSel = document.getElementById('scenario');
    const descEl = document.getElementById('scenario-desc');
    scenarioSel.addEventListener('change', () => {
      const sc = scenarios[scenarioSel.value];
      descEl.innerHTML = sc ? sc.description : '';
    });
    const runForm = document.getElementById('run-form');
    const runBtn = document.getElementById('run-btn');
    runForm.addEventListener('submit', () => {
      runBtn.disabled = true;
      runBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';
    });
</script>
{% if not records %}<p>No runs recorded.</p>{% endif %}
{% endblock %}
