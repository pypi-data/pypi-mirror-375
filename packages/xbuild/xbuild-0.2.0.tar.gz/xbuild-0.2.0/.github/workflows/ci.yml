name: CI
on:
  pull_request:
  push:
    branches:
      - main
  workflow_call:

# Cancel active CI runs for a PR before starting another run
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash  # https://github.com/beeware/briefcase/pull/912

env:
  FORCE_COLOR: "1"

jobs:
  pre-commit:
    name: Pre-commit checks
    uses: beeware/.github/.github/workflows/pre-commit-run.yml@main
    with:
      pre-commit-source: "--group pre-commit"

  package:
    name: Build Package
    needs: [ pre-commit ]
    runs-on: "ubuntu-24.04"
    permissions:
      id-token: write
      attestations: write
    steps:
    - name: Checkout
      uses: actions/checkout@v5.0.0
      with:
        fetch-depth: 0

    - name: Build and inspect package
      uses: hynek/build-and-inspect-python-package@v2.13.0
      with:
        attest-build-provenance-github: 'true'

  unit-tests:
    name: Unit tests
    needs: [ package ]
    runs-on: "ubuntu-24.04"
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.13", "3.14" ]

    steps:
    - name: Checkout
      uses: actions/checkout@v5.0.0
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v6.0.0
      with:
        python-version: "${{ matrix.python-version }}"
        allow-prereleases: true

    - name: Install test requirements
      run: |
        python -m pip install -U pip
        python -m pip install --group ci

    - name: Test
      run: |
        python -m tox -e py

    # # This step is only needed if you're trying to diagnose test failures that
    # # only occur in CI, and can't be reproduced locally. When it runs, it will
    # # open an SSH server (URL reported in the logs) so you can ssh into the CI
    # # machine.
    # - name: Setup tmate session
    #   uses: mxschmitt/action-tmate@v3
    #   if: failure()
