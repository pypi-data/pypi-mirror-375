"use strict";(self.webpackChunkcroquis_js=self.webpackChunkcroquis_js||[]).push([[604],{604:(t,e,i)=>{i.r(e),i.d(e,{CommWrapper:()=>j,CroquisWidget:()=>H,default:()=>Z});var s=i(980),l=i(43),_=i(256);const h=256,n=1.5,r=Number.MAX_SAFE_INTEGER;var o,a,c,d,u,g;function p(t,e=null){if(!t)throw e||"Should not happen!"}function f(t){return t*t}function m(){let t=new Date,e=(t,e)=>t.toString().padStart(e,"0");return e(t.getHours(),2)+":"+e(t.getMinutes(),2)+":"+e(t.getSeconds(),2)+"."+e(t.getMilliseconds(),3)}function v(t){t.style.display=""}function b(t,e){return t.querySelector(e)}!function(t){t.VIA_CANVAS="canvas",t.VIA_SEARCH="search"}(o||(o={}));class y{constructor(t){this._target=t,this._target.style.visibility="hidden",this._listener=null}show(){this._target.style.visibility="visible",null!=this._listener&&document.removeEventListener("click",this._listener),this._listener=t=>{this._target.contains(t.target)||this.hide()},window.setTimeout((()=>{this._listener&&document.addEventListener("click",this._listener)}),0)}hide(){this._target.style.visibility="hidden",null!=this._listener&&(document.removeEventListener("click",this._listener),this._listener=null)}}class x{constructor(t,e){this._maxsize=t,this._should_replace=e,this._d=new Map}clear(){this._d.clear()}delete(t){return this._d.delete(t)}get(t){var e;return null!==(e=this._d.get(t))&&void 0!==e?e:null}has(t){return this._d.has(t)}size(){return this._d.size}insert(t,e){let i=this.get(t);if(null==i||this._should_replace(i,e)){for(this._d.delete(t);this._d.size>=this._maxsize;)this._d.delete(this._d.keys().next().value);this._d.set(t,e)}}pop(t){let e=this._d.get(t);return null==e?null:(this._d.delete(t),e)}get d(){return this._d}}function w(t,e,i,s,l=null){return null==l?`${t}:${e}:${i}:${s}`:`${t}:${e}:${i}:${s}:${l}`}class k{constructor(t,e){this.item_id=null,this.label=null,this.style=null,this.hovermap=null;const i="item_id"in t;this.sm_version=t.sm_version,this.config_id=t.config_id,this.zoom_level=t.zoom_level,this.row=t.row,this.col=t.col,i&&(this.item_id=t.item_id,this.label=t.label,this.style=t.style),this.key=w(this.config_id,this.zoom_level,this.row,this.col,this.item_id);const s=e[0];this.elem=new Image(h,h),this.elem.classList.add("cr_tile"),this.elem.setAttribute("draggable","false"),this.elem.src=URL.createObjectURL(new Blob([s],{type:"image/png"})),i||(this.hovermap=e[1]instanceof ArrayBuffer?new DataView(e[1]):e[1])}is_hover(){return null!=this.item_id}}!function(t){t.X="x",t.Y="y"}(a||(a={}));class q{constructor(t,e,i,s){this._handler=t,this.axis=e,this.coord=i,e==a.X?(this._axis_cell=this._handler.x_axis,this._css_field="left"):e==a.Y?(this._axis_cell=this._handler.y_axis,this._css_field="top"):function(t=null){throw t||"Should not happen!"}(),this._tick=document.createElement("div"),this._tick.classList.add("cr_tick"),this._label=document.createElement("div"),this._label.classList.add("cr_label"),this._label.textContent=s,this._line=document.createElement("div"),this._line.classList.add(`${e}_grid`),this.update_location(),this._axis_cell.appendChild(this._tick),this._axis_cell.appendChild(this._label),this._handler.grid.appendChild(this._line)}remove(){this._tick.remove(),this._label.remove(),this._line.remove()}update_location(){let t=this._handler.tile_handler.tile_set;const[e,i]=this.axis==a.X?[t.x_offset,t.width]:[t.y_offset,t.height],s=Math.round(e+this.coord);for(let t of[this._tick,this._label,this._line])s>=0&&s<i?(t.style[this._css_field]=s+"px",t.style.visibility="visible"):t.style.visibility="hidden"}}class ${constructor(t,e,i){this._ctxt=t,this.tile_handler=e,this._replayer=i,this._ticks=[],this._next_seq=0,this._last_seq=-1,this._inflight_reqs=new Map,this._last_x_offset=0,this._last_y_offset=0;const s=t.root_node;this._x_axis=b(s,".cr_x_axis"),this._y_axis=b(s,".cr_y_axis"),this._grid=b(s,".cr_grid")}update(t){if("canvas_config"==t.msg)this._last_seq=-1,this._next_seq=0,this._last_x_offset=this._last_y_offset=0;else if("axis_ticks"==t.msg){if(this._inflight_reqs.delete(t.axis_seq),t.config_id!=this.tile_handler.tile_set.config_id||t.axis_seq<this._last_seq)return;this._last_seq=t.axis_seq,this._last_x_offset=t.x_offset,this._last_y_offset=t.y_offset}for(let t of this._ticks)t.remove();this._ticks.length=0;for(let e of[a.X,a.Y])for(let[i,s]of t.axes[e])this._ticks.push(new q(this,e,i,s))}update_location(t){for(let t of this._ticks)t.update_location();let e=this.tile_handler.tile_set;if(!t&&f(e.x_offset-this._last_x_offset)+f(e.y_offset-this._last_y_offset)<f(30))return;if(this._replayer.log("Creating new axis_req message ..."),this._inflight_reqs.size>=2)return void this._replayer.log("Too many in-flight axis requests, bailing out ...");const i=this._next_seq++;this._inflight_reqs.set(i,Date.now()),this._last_x_offset=Math.round(e.x_offset),this._last_y_offset=Math.round(e.y_offset),this._ctxt.send("axis_req",{config:e.current_canvas_config(),axis_seq:i})}expire_old_requests(){let t=Date.now()-5e3;for(let[e,i]of this._inflight_reqs)i<t&&(this._replayer.log(`Forgetting old seq #${e} ...`),this._inflight_reqs.delete(e))}update_crosshair(t,e){if(null==t){for(let t of this._grid.querySelectorAll(".nearest_x, .nearest_y"))t.remove();return}let i=document.createElement("div");i.classList.add("nearest_x"),i.style.left=t+"px",this._grid.appendChild(i);let s=document.createElement("div");s.classList.add("nearest_y"),s.style.top=e+"px",this._grid.appendChild(s)}get x_axis(){return this._x_axis}get y_axis(){return this._y_axis}get grid(){return this._grid}}!function(t){t.DISABLED="disabled",t.RECORDING="recording",t.RUNNING="running"}(c||(c={}));class E{constructor(t,e){if(this._btns_div=t,this._fn_map=e,this._enabled=!1,this.status=c.DISABLED,this._status_area=null,this.rel_time=null,this._events=[],this._event_log=[],this._start_T=Date.now(),null==t)return void(this._enabled=!1);this._enabled=!0,this._status_area=t.querySelector("span"),this.reset(c.DISABLED);let i=t.querySelectorAll("button");i[0].onclick=()=>{this.start_recording()},i[1].onclick=()=>{this.stop_recording()},i[2].onclick=()=>{this.save()},i[3].onclick=()=>{this.load()},i[4].onclick=()=>{this.start_replay()},i[5].onclick=()=>{this.clear()}}clear(){this._enabled&&(this.reset(c.DISABLED),this._fn_map.reset({}),this._status_area.textContent="(Empty)")}start_recording(){this._enabled&&(this.reset(c.RECORDING),this._fn_map.reset({}),this._status_area.textContent="Recording ...")}stop_recording(){this._enabled&&(this.status=c.DISABLED,this._status_area.textContent=`Stopped: has ${this._events.length} events.`)}save(){if(!this._enabled)return;const t=this._event_log.join("\n"),e=new Blob([t],{type:"text/plain"});let i=document.createElement("a"),s=URL.createObjectURL(e);i.href=s,i.download="event_log.txt",document.body.appendChild(i),i.click(),window.setTimeout((()=>{document.body.removeChild(i),window.URL.revokeObjectURL(s)}),0)}load(){if(!this._enabled)return;let t=document.createElement("input");t.type="file",t.style.display="none";let e=e=>{let i=e.target.result;document.body.removeChild(t),this.load_handler(i)};t.onchange=i=>{let s=t.files[0];if(null==s)return;let l=new FileReader;l.onload=e,l.readAsText(s)},document.body.appendChild(t),t.click()}load_handler(t){if(this._enabled){this._events=[],this._event_log=[];for(const e of t.split("\n")){let t=e.match(/[0-9:.]+ +#[0-9]+: *(\[.*\])$/);t&&this._events.push(JSON.parse(t[1]))}this._status_area.textContent=`Loaded ${this._events.length} events.`}}record_event(t,e){if(!this._enabled)return;if(this.status!=c.RUNNING&&(this.rel_time=Date.now()-this._start_T),this.status!=c.RECORDING)return;const i=this._events.length,s={rel_time:this.rel_time,event_type:t,args:e};this._events.push(s),this._event_log.push(`${m()} #${i}: `+JSON.stringify(s)),this._status_area.textContent=`Recorded ${i+1} events ...`}start_replay(){this._enabled&&this._events.length>0&&(this.reset(c.RUNNING),this._fn_map.reset({}),this.replay_event(0))}replay_event(t){if(!this._enabled)return;if(this.status!=c.RUNNING)return;const e=this._events[t];this._event_log.push(`${m()} #${t}: `+JSON.stringify(e)),this.rel_time=e.rel_time;const i=e.event_type,s=e.args,l=`event #${t} of ${this._events.length} : at ${this.rel_time}: ${i}(${JSON.stringify(s)})`;this._status_area.textContent=`Replaying ${l} ...`,(this._fn_map[i](s||{})||Promise.resolve(!0)).then((()=>{if((t+=1)>=this._events.length)return void(this._status_area.textContent=`Replay finished for ${this._events.length} events.`);let e=this._events[t].rel_time;window.setTimeout((()=>{this.replay_event(t)}),(e-this.rel_time)/.2),this._status_area.textContent=`Executed ${l}.`})).catch((t=>{this._status_area.textContent=`Error executing ${l}: ${t}`,this.status=c.DISABLED}))}reset(t){this._enabled&&(this._start_T=Date.now(),this.rel_time=0,t!=c.RUNNING&&(this._events=[]),this._event_log=[],this.status=t)}log(...t){if(!this._enabled)return;if(this.status==c.DISABLED)return;const e=this.status==c.RUNNING?this.rel_time:Date.now()-this._start_T,i=t.map((t=>"object"==typeof t?JSON.stringify(t):t)).join(" ");this._event_log.push(`${m()}    [${e}] ${i}`)}}!function(t){t.STOPPED="stopped",t.MOVING="moving",t.OUTSIDE="outside"}(d||(d={})),function(t){t.UP="up",t.SELECT_TO_ZOOM="select_to_zoom",t.PAN="pan"}(u||(u={}));class N{constructor(t,e,i){this._parent=e,this._replayer=i,this._mouse_stopped_cb=null,this.move=d.MOVING,this._btn=u.UP,this.mouse_x=0,this.mouse_y=0,this.mouse_btns=0,this._start_x=null,this._start_y=null,this._x_offset0=null,this._y_offset0=null;const s=t.root_node;this._canvas=b(s,".cr_canvas"),this._zoom_radio_btn=b(s,".cr_zoom"),this._select_area=b(s,".cr_select_area"),this.reset();for(let t of["mousedown","mouseleave","mousemove","mouseup"])this._canvas.addEventListener(t,(e=>{let i=e;if(this._replayer.status==c.RUNNING)return;let s=this._canvas.getBoundingClientRect();this.mouse_x=i.clientX-s.left,this.mouse_y=i.clientY-s.top,this.mouse_btns=i.buttons,this.mouse_handler_cb(t)}))}reset(){this._btn=u.UP,this.move!=d.STOPPED&&(this.move=d.MOVING),this._start_x=this._start_y=null,this._x_offset0=this._y_offset0=null,this.clear_select_area()}replay_mouse_event(t){this.mouse_x=t.x,this.mouse_y=t.y,this.mouse_btns=t.btns,this.mouse_handler_cb(t.name)}mouse_handler_cb(t){const[e,i,s]=[this.mouse_x,this.mouse_y,this.mouse_btns];if(this._replayer.record_event("mouse",{name:t,x:e,y:i,btns:s}),this._replayer.log(`mouse_handler_cb: status=${this}`),"mouseleave"==t)return this.move=d.OUTSIDE,this.clear_mouse_stop_cb(),this.clear_select_area(),this._parent.clear_highlight(),void this._parent.hide_tooltip();if("stopped"==t)return this.move=d.STOPPED,void("up"==this._btn&&(this._parent.handle_mouse_stop(e,i),this._parent.recompute_highlight()));"mousemove"==t&&this.clear_mouse_stop_cb();const l=this.move;this.move==d.OUTSIDE&&(this.move=d.MOVING);const _="up"!=this._btn,h=!(1&~s);let n=this._parent.tile_set;if("mousedown"==t&&!_&&h)return this._parent.clear_highlight(),this._parent.hide_tooltip(),this._start_x=e,this._start_y=i,void(this._zoom_radio_btn.checked?this._btn=u.SELECT_TO_ZOOM:(this._btn=u.PAN,this._x_offset0=n.x_offset,this._y_offset0=n.y_offset));if(_&&!h){if(this._btn==u.SELECT_TO_ZOOM&&"outside"!=l)if(Math.sqrt(f(this._start_x-e)+f(this._start_y-i))<5)this._replayer.log("Selected area too small, ignoring ...");else{const t={px0:this._start_x-n.x_offset,py0:this._start_y-n.y_offset,px1:e-n.x_offset,py1:i-n.y_offset};this._replayer.log("Sending zoom request:",t),n.send_zoom_req(t)}else"pan"==this._btn&&"outside"!=l&&this._parent.handle_panning(this._x_offset0+e-this._start_x,this._y_offset0+i-this._start_y);return this.clear_select_area(),void(this._btn=u.UP)}this._btn==u.UP?(this._parent.update_mouse_history(e,i),this._parent.recompute_highlight(),this.enqueue_mouse_stop_cb()):this._btn==u.SELECT_TO_ZOOM?this.show_select_area(e,i):this._btn==u.PAN?this._parent.handle_panning(this._x_offset0+e-this._start_x,this._y_offset0+i-this._start_y):p(!1)}enqueue_mouse_stop_cb(){this._replayer.status!=c.RUNNING&&(this._mouse_stopped_cb=window.setTimeout((()=>this.mouse_handler_cb("stopped")),30))}clear_mouse_stop_cb(){null!=this._mouse_stopped_cb&&(window.clearTimeout(this._mouse_stopped_cb),this._mouse_stopped_cb=null)}show_select_area(t,e){const[i,s]=[this._start_x,this._start_y];this._select_area.style.visibility="visible",this._select_area.style.top=Math.min(s,e)+"px",this._select_area.style.left=Math.min(i,t)+"px",this._select_area.style.width=Math.abs(i-t)+"px",this._select_area.style.height=Math.abs(s-e)+"px"}clear_select_area(){this._select_area.style.visibility="hidden"}toString(){return this._btn+"-"+this.move}}function M(t,e,i){let s=t.querySelectorAll(e);p(s.length>0,`No element matching ${e}`);for(let t of s)i(t)}function S(t){let e=[];for(let i of t.split(";")){if(i=i.trim(),""==i)continue;let t=i.match(/([^ ]+)\s*:\s*([^ ].*)/);p(null!=t,`Cannot parse "CSS" string ${i}`),e.push([t[1],t[2]])}return e}function C(t,e){for(let[i,s]of e){let e=S(s);M(t,i,(t=>{for(let[i,s]of e)t.style.setProperty(i,s)}))}}function z(t,e,i){p("row"==e||"column"==e,`Invalid dir ${e}`),t.style.display="flex",t.style.setProperty("flex-direction",e);for(let[e,s]of i)M(t,e,(t=>{t.style.flex=s}))}class R{constructor(t,e,i,s,l){if(this.item_id=t,this.selected=e,this.label=i,this.style=s,this.elem=null,this.checkbox=null,this.highlighted=!1,t==r)return void(this.elem=null);this.elem=document.createElement("li"),this.checkbox=document.createElement("input"),this.checkbox.type="checkbox",this.checkbox.checked=this.selected,this.elem.appendChild(this.checkbox),this.elem.appendChild(this.create_line_svg()),this.elem.appendChild(document.createTextNode(this.label));let _=t=>l(this,t);this.elem.addEventListener("mouseenter",_),this.elem.addEventListener("mousemove",_),this.elem.addEventListener("mouseleave",_)}update_selected(t){this.item_id!=r&&(this.selected=t,this.checkbox.checked=t,0==t&&this.update_highlight(!1))}update_highlight(t){this.item_id!=r&&(t&&!this.highlighted?(this.highlighted=!0,this.elem.classList.add("highlighted")):!t&&this.highlighted&&(this.highlighted=!1,this.elem.classList.remove("highlighted")))}clear_highlight(){this.item_id}create_line_svg(){const[t,e]=[40,8],[i,s]=[t/2,e/2];let[l,_,h]=this.style.split(":"),n=Math.min(Number(_),8),r=Math.min(Number(h),5),o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("viewBox",`0 0 ${t} ${e}`),o.setAttribute("width",`${t}px`),o.setAttribute("height",`${e}px`);let a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("stroke","#"+l),a.setAttribute("stroke-width",r.toString()),a.setAttribute("d",`M 0,${s} L ${t},${s}`),o.appendChild(a);let c=document.createElementNS("http://www.w3.org/2000/svg","circle");return c.setAttribute("cx",i.toString()),c.setAttribute("cy",s.toString()),c.setAttribute("r",(n/2).toString()),c.setAttribute("fill","#"+l),o.appendChild(c),o}}!function(t){t.INITIAL="initial",t.ERROR="error",t.OK="ok"}(g||(g={}));class I{constructor(t){this._bar=t,this._status=g.INITIAL,this._show_progressbar_cb=null,this._show_progressbar_cb=window.setTimeout((()=>{this._bar.innerHTML="Please wait, the graph is being generated ...",this._bar.style.visibility="visible"}),500)}on_comm_error(t){this.clear_cb(),this._status=g.ERROR,this._bar.innerHTML="Cannot connect to backend!  Please rerun the cell.",this._bar.style.visibility="visible"}on_comm_ok(){this.clear_cb(),this._status=g.OK,this._bar.style.visibility="hidden"}clear_cb(){null!=this._show_progressbar_cb&&(window.clearTimeout(this._show_progressbar_cb),this._show_progressbar_cb=null)}}const L=Symbol("unknwon");var A;!function(t){t.RESET="reset",t.RESIZE="resize"}(A||(A={}));class T{constructor(t,e){this._ctxt=t,this._canvas=e,this.config_id=-1,this.width=-1,this.height=-1,this.x0=null,this.y0=null,this.x1=null,this.y1=null,this.zoom_level=0,this.x_offset=0,this.y_offset=0,this.last_config_req={config_id:-1,width:0,height:0},this.sm_version=0,this.highlight_item_id=null,this.highlight_trigger=null,this.visible_tiles=new Map,this.tile_cache=new x(500,((t,e)=>t.sm_version<e.sm_version)),this._ctxt_id=t.ctxt_id,this.inner_div=b(this._canvas,".cr_inner"),this.fg=b(this._canvas,".cr_foreground")}resize_canvas(t){const e=t==A.RESIZE,i=Math.round(this._canvas.clientWidth),s=Math.round(this._canvas.clientHeight);if(e&&i==this.last_config_req.width&&s==this.last_config_req.height)return;const l=this.last_config_req.config_id+1;console.log(`Resize canvas ${this._ctxt_id} config_id=${l} w=${i} h=${s}`),this.last_config_req={config_id:l,width:i,height:s},e&&this.has_valid_config()?this._ctxt.send("canvas_config_req",{config_id:l,w:i,h:s,how:"resize",old_config:this.current_canvas_config()}):(e&&console.log("No valid config yet, asking for reset ..."),this._ctxt.send("canvas_config_req",{config_id:l,w:i,h:s,how:"reset"}))}send_zoom_req(t){if(!this.has_valid_config())return void console.log("Cannot resize: doesn't have a valid config yet!");const e=this.last_config_req.config_id+1,i=Math.round(this._canvas.clientWidth),s=Math.round(this._canvas.clientHeight);console.log(`Zoom canvas ${this._ctxt_id} config_id=${e} w=${i} h=${s}`),this.last_config_req={config_id:e,width:i,height:s},this._ctxt.send("canvas_config_req",{config_id:e,w:i,h:s,how:"zoom",old_config:this.current_canvas_config(),zoom:t})}has_valid_config(){return null!=this.x0}current_canvas_config(){return{config_id:this.config_id,w:this.width,h:this.height,x0:this.x0,y0:this.y0,x1:this.x1,y1:this.y1,zoom_level:this.zoom_level,x_offset:Math.round(this.x_offset),y_offset:Math.round(this.y_offset)}}add_config(t){const e=t.config;return this.config_id>=t.config_id?(console.log(`canvas_config message contains stale config ID ${t.config_id}: we already have ${this.config_id}.`),!1):(this.config_id=e.config_id,this.height=e.h,this.width=e.w,this.x0=e.x0,this.y0=e.y0,this.x1=e.x1,this.y1=e.y1,p(0==e.zoom_level&&0==e.x_offset&&0==e.y_offset),this.zoom_level=0,this.x_offset=0,this.y_offset=0,!0)}has_tile(t){return this.visible_tiles.has(t)||this.tile_cache.has(t)}get_tile(t){return this.visible_tiles.get(t)||this.tile_cache.get(t)||null}refresh(){for(let t of this.visible_tiles.values())this.is_visible(t)||this.hide_tile(t);for(let[t,e]of this.tile_cache.d)this.is_visible(e)&&(this.tile_cache.delete(t),this.show_tile(e))}add_tile(t){if(!this.is_visible(t))return void this.tile_cache.insert(t.key,t);let e=this.visible_tiles.get(t.key);if(null!=e){if(!(e.sm_version<t.sm_version))return;this.show_tile(t,e)}else this.show_tile(t)}set_highlight(t,e){this.highlight_item_id=t,this.highlight_trigger=e;for(let e of this.visible_tiles.values()){if(!e.is_hover()||e.item_id==t)continue;if(null==t){this.hide_tile(e);continue}const i=this.tile_key(e.row,e.col,t);let s=this.tile_cache.pop(i);null!=s?this.show_tile(s,e):this.hide_tile(e)}for(let[e,i]of this.get_all_tile_coords()){const s=this.tile_key(e,i,t);let l=this.tile_cache.pop(s);null!=l&&this.show_tile(l)}}pan(t,e){this.x_offset=t,this.y_offset=e;for(let t of this.visible_tiles.values())this.is_visible(t)?this.update_tile_position(t):this.hide_tile(t);for(let[t,e]of this.get_all_tile_coords()){const i=this.tile_key(t,e);let s=this.tile_cache.pop(i);null!=s&&this.show_tile(s)}}show_tile(t,e=null){this.update_tile_position(t);let i=t.is_hover()?this.fg:this.inner_div;null!=e?(this.visible_tiles.delete(e.key),i.replaceChild(t.elem,e.elem),e.key!=t.key&&this.tile_cache.insert(e.key,e)):i.appendChild(t.elem),this.visible_tiles.set(t.key,t)}update_tile_position(t){t.elem.style.top=t.row*h+this.y_offset+"px",t.elem.style.left=t.col*h+this.x_offset+"px"}hide_tile(t){this.visible_tiles.delete(t.key),t.elem.remove(),this.tile_cache.insert(t.key,t)}get_highlight_id(t,e){t=Math.round(t-this.x_offset),e=Math.round(e-this.y_offset);const i=Math.floor(e/h),s=Math.floor(t/h),l=(e-i*h)*h+(t-s*h),_=this.tile_key(i,s);if(!this.visible_tiles.has(_))return L;const n=this.visible_tiles.get(_).hovermap;p(null!=n);let r=n.getInt32(4*l,!0);return-1==r?null:r}is_visible(t){if(t.is_hover()&&t.item_id!=this.highlight_item_id)return!1;if(t.config_id!=this.config_id||t.zoom_level!=this.zoom_level)return!1;const e=t.row*h+this.y_offset,i=t.col*h+this.x_offset;return e>-256&&e<this.height&&i>-256&&i<this.width}get_tile_coord(t,e){return t=Math.round(t-this.x_offset),e=Math.round(e-this.y_offset),[Math.floor(e/h),Math.floor(t/h)]}get_all_tile_coords(){if(null==this.width||null==this.height)return console.log("Error: create_highlight_req called before width/height is available???"),[];let t=[];const e=Math.floor(-this.y_offset/h),i=Math.floor(-this.x_offset/h),s=Math.ceil((this.height-this.y_offset)/h)-1,l=Math.ceil((this.width-this.x_offset)/h)-1;for(let _=e;_<=s;_++)for(let e=i;e<=l;e++)t.push([_,e]);return t}tile_key(t,e,i=null){return w(this.config_id,this.zoom_level,t,e,i)}new_sm_version(){return this.sm_version+=2}}class D{constructor(){this._cache=new x(10,((t,e)=>!0))}insert(t){const e=[t.config.config_id,t.config.zoom_level,t.config.x_offset,t.config.y_offset,t.mouse_x,t.mouse_y,t.item_id],i={data_x:t.data_x,data_y:t.data_y,screen_x:t.screen_x,screen_y:t.screen_y};this._cache.insert(e.map(Math.round).join(":"),i)}get(t,e,i,s,l,_,h){const n=[t,e,i,s,l,_,h].map(Math.round).join(":");return this._cache.get(n)}}class B{constructor(t){this._labels=[new R(r,!1,"","",null)],this._label_map=new Map,this._highlighted_label=null,this._tile_update_stalled=!1,this._next_seq=0,this._inflight_reqs=new Map,this._ack_seqs=[],this._received_tiles=[],this._update_T=null,this._hide_cb=null,this._highlight_change_time=null,this._mouse_hist=[],this._waypoints=[];const e=t.root_node,i=b(e,".cr_main1");i.innerHTML='\n<div class="cr_y_axis_container">\n  <div class="cr_y_axis"></div>\n</div>\n<div class="cr_canvas_plus_x_axis">\n  <div class="cr_canvas">\n    <div class="cr_height_adjuster"></div>\n    <div class="cr_statusbar"></div>\n    <div class="cr_inner"></div>\n    <div class="cr_foreground"></div>\n    <div class="cr_grid"></div>\n    <div class="cr_select_area"></div>\n  </div>\n  <div class="cr_x_axis"></div>\n  \x3c!-- cr_tooltip cannot be inside cr_canvas because cr_canvas has\n       "overflow: hidden" but the tooltip could be partially out of the\n       canvas. --\x3e\n  <div class="cr_tooltip"></div>\n</div>\n<div class="cr_legend">\n  <div class="cr_searchbox">\n    <input type="text" placeholder="(all shown)"/>\n  </div>\n  <div class="cr_search_ctrl">\n    <input type=checkbox class="cr_regex"/>Regex\n    <input type=checkbox class="cr_autoselect" checked/>Autoselect\n    <button class="cr_more">More...</button>\n    <ul class="cr_btn_popup">\n        <li><a class="cr_select_all">Select all</a></li>\n        <li><a class="cr_deselect_all">Deselect all</a></li>\n        \x3c!-- text for the following two links are filled in\n             dynamically. --\x3e\n        <li><a class="cr_select_matching"></a></li>\n        <li><a class="cr_deselect_matching"></a></li>\n    </ul>\n  </div>\n  <div class="cr_search_stat"></div>\n  <ul class="cr_search_result"></ul>\n  \x3c!-- <div class="cr_info"></div> --\x3e\n</div>\n',function(t){for(let e of[".cr_canvas",".cr_inner",".cr_foreground",".cr_grid",".cr_select_area"])M(t,e,(t=>{t.draggable=!1}))}(i),z(i,"row",[[".cr_y_axis_container","0 0 60px"],[".cr_canvas_plus_x_axis","0.9 1 320px"]]),C(i,[[".cr_y_axis_container","position: relative;"],[".cr_y_axis","position: absolute;\n                            top: 0px; bottom: 28px;\n                            left: 0px; right: 0px;"]]),z(b(e,".cr_canvas_plus_x_axis"),"column",[[".cr_canvas","1 0 auto"],[".cr_x_axis","0 0 30px"]]),C(i,[[".cr_x_axis","border-top: 2px solid black;"],[".cr_y_axis","border-right: 2px solid black;"],[".cr_x_axis, .cr_y_axis","box-sizing: border-box;"],[".cr_x_axis","position: relative; font-size: 12px; overflow: visible;"],[".cr_y_axis","font-size: 12px; overflow: visible;"],[".cr_canvas","overflow: hidden; position: relative;"],[".cr_statusbar, .cr_inner, .cr_foreground, .cr_grid, .cr_select_area","position: absolute; left: 0px; top: 0px;"],[".cr_height_adjuster","height: 0px; padding-bottom: 60%;"],[".cr_canvas","height: auto;"]]),this._tile_replay_cb=null,this._tile_replay_buf=[];let s=b(e,"cr_dbg_btns");this._replayer=new E(s,{reset:()=>{this.tile_set.set_highlight(null,null),this.tile_set.tile_cache.clear(),this.reset_state()},mouse:t=>this._mouse_handler.replay_mouse_event(t),clear2:()=>this.clear_highlight2(),clear3:()=>this.clear_highlight3(),tile:t=>new Promise(((e,i)=>{this.tile_replay_handler(e,t.keys,0)}))}),this._ctxt=t,this.status_bar=new I(b(e,".cr_statusbar")),this._canvas=b(e,".cr_canvas"),this.tile_set=new T(t,this._canvas),this._resize_observer=new ResizeObserver((()=>{this.tile_set.resize_canvas(A.RESIZE)})),this._resize_observer.observe(this._canvas),this.axis_handler=new $(t,this,this._replayer),this._fg=b(e,".cr_foreground"),this._mouse_handler=new N(t,this,this._replayer),this._tooltip=b(e,".cr_tooltip"),this.nearest_pts=new D,this._searchbox=b(e,".cr_searchbox input"),this._searchbox.addEventListener("input",(t=>this.search_handler(t))),this._search_result_area=b(e,".cr_search_result"),b(e,".cr_home_btn").addEventListener("click",(t=>{this.tile_set.resize_canvas(A.RESET)})),b(e,".cr_zoom_in_btn").addEventListener("click",(t=>{this.tile_set.zoom_level++,this.tile_set.x_offset*=n,this.tile_set.y_offset*=n,this.tile_set.refresh(),this.axis_handler.update_location(!0),this.request_new_tiles()})),b(e,".cr_zoom_out_btn").addEventListener("click",(t=>{this.tile_set.zoom_level--,this.tile_set.x_offset/=n,this.tile_set.y_offset/=n,this.tile_set.refresh(),this.axis_handler.update_location(!0),this.request_new_tiles()})),(this._btn_regex=b(e,".cr_regex")).addEventListener("change",(t=>this.search_handler(t))),(this._btn_autoselect=b(e,".cr_autoselect")).addEventListener("change",(t=>this.autoselect_handler(t))),this._btn_popup=new y(b(e,".cr_btn_popup")),b(e,".cr_more").addEventListener("click",(t=>{""!=this._searchbox.value?(this._btn_select_matching.textContent="Select all matching "+this._searchbox.value,v(this._btn_select_matching.parentNode),this._btn_deselect_matching.textContent="Deselect all matching "+this._searchbox.value,v(this._btn_select_matching.parentNode)):(v(this._btn_select_matching.parentNode),v(this._btn_select_matching.parentNode)),this._btn_popup.show()})),b(e,".cr_select_all").addEventListener("click",(t=>this.select_btn_handler(t,"select_all"))),b(e,".cr_deselect_all").addEventListener("click",(t=>this.select_btn_handler(t,"deselect_all"))),(this._btn_select_matching=b(e,".cr_select_matching")).addEventListener("click",(t=>this.select_btn_handler(t,"select_matching"))),(this._btn_deselect_matching=b(e,".cr_deselect_matching")).addEventListener("click",(t=>this.select_btn_handler(t,"deselect_matching"))),this._search_stat_area=b(e,".cr_search_stat"),this.reset_state(),this.search_handler(null)}cleanup(){this._resize_observer.disconnect()}reset_state(){this._update_T=null,this._hide_cb=null,this._highlight_change_time=null,this._mouse_hist=[],this._waypoints=[]}register_canvas_config(t){this.tile_set.add_config(t)&&(this._mouse_handler.reset(),this.axis_handler.update(t))}register_tile(t,e){for(let t of e)this._inflight_reqs.delete(t),this._ack_seqs.push(t);this._replayer.log(`Received tile [${t.sm_version}]${t.key} seq=${e}`),this._received_tiles.push(t),1==this._received_tiles.length&&window.setTimeout((()=>{this.register_tile_cb()}),0)}register_tile_cb(){let t=this._received_tiles;this._received_tiles=[];const e=t.map((t=>t.key));this._replayer.record_event("tile",{keys:e}),this._replayer.status==c.RUNNING?this._tile_replay_cb&&this._tile_replay_cb(t):this.register_tile_internal(t)}tile_replay_handler(t,e,i){if(i==e.length)return this.register_tile_internal(this._tile_replay_buf),this._tile_replay_cb=null,this._tile_replay_buf=[],void t();const s=e[i];this._tile_replay_cb=l=>{let _=l[0];_.key==s&&(this._tile_replay_buf.push(_),i++),this.tile_replay_handler(t,e,i)};const[l,_,h,n,r]=s.split(":").map((t=>parseInt(t)));let o=this._ack_seqs;this._ack_seqs=[];let a=this._next_seq++;this._inflight_reqs.set(a,Date.now()),this._ctxt.send("tile_req",{ack_seqs:o,config:this.tile_set.current_canvas_config(),items:[{id:r,prio:[`${h}:${n}:${a}`],reg:[]}]})}register_tile_internal(t){let e=!1;for(let i of t)this._replayer.log(`Adding tile: ${i.key}`),this.tile_set.add_tile(i),e=e||i.is_hover();if(this.tile_set.visible_tiles.size>0&&this.status_bar.on_comm_ok(),this._tile_update_stalled){const t=this.create_tile_req();null!=t&&(this._replayer.log("Sending new tile_req after stall:",t),this._ctxt.send("tile_req",t))}if(this._mouse_handler.move==d.STOPPED)return console.log("BBB calling stopped handler!!"),void this._mouse_handler.mouse_handler_cb("stopped");e&&(this.tile_set.highlight_trigger==o.VIA_SEARCH?this.tile_set.set_highlight(this.tile_set.highlight_item_id,o.VIA_SEARCH):this.recompute_highlight())}handle_panning(t,e){this.tile_set.pan(t,e),this.request_new_tiles(),this.axis_handler.update_location(!1)}handle_mouse_stop(t,e){this._replayer.log(`handle_mouse_stop: ${t} ${e}`);let i=this.tile_set.get_highlight_id(t,e);if(i===L)return;this._replayer.log("current item_id = ",i);let s=[{x:t,y:e,item_id:i}];const l=this.create_highlight_req(s);null!=l&&(this._replayer.log("Mouse stopped, highlight_req:",l),this._replayer.status!=c.RUNNING&&(this._ctxt.send("tile_req",l),l.throttled&&this._mouse_handler.enqueue_mouse_stop_cb()))}update_mouse_history(t,e){let i=this._mouse_hist;const s=this._replayer.rel_time,l={t:s,x:t,y:e};if(s-(i.length?i[i.length-1].t:0)<5)return this._replayer.log("update_mouse_history called too quickly: ignoring ..."),void(i[i.length-1]=l);let _=0;for(;_<i.length&&i[_].t<s-150;)_++;if(_>0&&i.splice(0,_),i.push(l),this._replayer.log("mouse_hist = ",i),i.length<=1)return;let h=0,n=0,r=0,o=0,a=0,c=0;const d=i.length;for(const t of i){const e=t.t-s;h+=e,n+=e*e,r+=t.x,o+=t.y,a+=e*t.x,c+=e*t.y}const u=d*n-h*h,g=(d*a-h*r)/u,p=(r-g*h)/d,m=(d*c-h*o)/u,v=(o-m*h)/d,b=Math.sqrt(f(t-p)+f(e-v));if(this._replayer.log(`Mouse = (${t}, ${e}) / Predicted = (${p.toFixed(2)}, ${v.toFixed(2)}) / error (distance) = ${b.toFixed(2)}`),b>50)return this._replayer.log("Prediction error too high, resetting mouse history ..."),void i.splice(0,i.length-1);if(b>5)return;const y=20*g+p,x=20*m+v;this.draw_prediction_line(t,e,y,x)}draw_prediction_line(t,e,i,s){if(this._replayer.log(`draw_prediction_line() called: x0=${t.toFixed(2)} y0=${e.toFixed(2)} x1=${i.toFixed(2)} y1=${s.toFixed(2)}`),Math.abs(i-t)+Math.abs(s-e)<1)return;let l=[],_=0,h=(t,e)=>{t=Math.round(t),e=Math.round(e);const i=this.tile_set.get_highlight_id(t,e);if(i==L)return!1;const s={x:t,y:e,item_id:i};if(0==l.length||l[l.length-1].item_id!=i)return l.push(s),_+=1,_<=5;if(1==l.length)return l.push(s),!0;let h=l[l.length-2];return h.item_id!=i?(l.push(s),!0):f(h.x-t)+f(h.y-e)<f(10)?(l[l.length-1]=s,!0):(l.push(s),!0)};if(Math.abs(i-t)>=Math.abs(s-e)){let l=Math.round(t),_=Math.round(i),n=(s-e)/(i-t);if(l<_)for(;l<=_&&h(l,e+n*(l-t));l++);else for(;l>=_&&h(l,e+n*(l-t));l--);}else{let l=Math.round(e),_=Math.round(s),n=(i-t)/(s-e);if(l<_)for(;l<=_&&h(t+n*(l-e),l);l++);else for(;l>=_&&h(t+n*(l-e),l);l--);}const n=this._waypoints.length,r=l.length;n+r>50&&this._waypoints.splice(0,n+r-50),this._replayer.log("Appending to waypoints:",l),this._waypoints.push(...l);const o=this.create_highlight_req(l);null!=o&&(this._replayer.log("Sending highlight_req:",o),this._replayer.status!=c.RUNNING&&this._ctxt.send("tile_req",o))}create_highlight_req(t){this._replayer.log(`create_highlight_req: currently has ${this._inflight_reqs.size} in-flight requests.`),this.expire_old_requests();const e=this.tile_set.get_all_tile_coords();let i=new Map;for(let s of t)if(null!=s.item_id)if(i.has(s.item_id)||i.set(s.item_id,new Set),null!=s.x){const[t,e]=this.tile_set.get_tile_coord(s.x,s.y);i.get(s.item_id).add(`${t}:${e}`)}else for(let[t,l]of e)i.get(s.item_id).add(`${t}:${l}`);let s=!1,l=(t,l,_)=>{for(let[h,n]of e){const e=this.tile_set.tile_key(h,n,l);if(this.tile_set.has_tile(e))continue;const r=`${h}:${n}`;if(_==i.get(l).has(r)){if(this._inflight_reqs.size>=50)return void(s=!0);const e=this._next_seq++;this._inflight_reqs.set(e,Date.now()),t.push(`${r}:${e}`)}}},_=new Map;for(let t of i.keys()){let e=[];l(e,t,!0),e.length>0&&_.set(t,{id:t,prio:e,reg:[]})}for(let t of i.keys()){let e=[];l(e,t,!1),0!=e.length&&(_.has(t)?_.get(t).reg=e:_.set(t,{id:t,prio:[],reg:e}))}if(0==_.size)return null;const h=this._ack_seqs;return this._ack_seqs=[],{ack_seqs:h,config:this.tile_set.current_canvas_config(),items:Array.from(_.values()),throttled:s}}recompute_highlight(){const[t,e]=[this._mouse_handler.mouse_x,this._mouse_handler.mouse_y],[i,s]=this.tile_set.get_tile_coord(t,e);if(this._replayer.log(`recompute_highlight() called: x=${t} y=${e} row=${i} col=${s} state=${this._mouse_handler}`),"outside"==this._mouse_handler.move)return;let l=null,_=null,h=f(30),n=null,r=null;const[a,c]=[Math.round(t),Math.round(e)];for(let o=a-5;o<=a+5;o++)for(let a=c-5;a<=c+5;a++){const c=f(t-o)+f(e-a);if(c>=h)continue;const d=this.tile_set.get_highlight_id(o,a);if(null==d||d==L)continue;const u=this.tile_set.tile_key(i,s,d);this.tile_set.has_tile(u)&&(l=this.tile_set.get_tile(u),_=d,h=c,n=o,r=a)}if(this._replayer.log(`best_item_id found: ${_} from:`,n,r),null==_&&"moving"==this._mouse_handler.move)for(let n of this._waypoints){let r=f(n.x-t)+f(n.y-e);if(r>=h)continue;const o=this.tile_set.tile_key(i,s,n.item_id);this.tile_set.has_tile(o)&&(l=this.tile_set.get_tile(o),_=n.item_id,h=r)}if(this._replayer.log(`recompute_highlight: best id ${_} current = `+this.tile_set.highlight_item_id),_!=this.tile_set.highlight_item_id&&(null!=_?(this._highlight_change_time=this._replayer.rel_time,this.set_highlight(_,o.VIA_CANVAS)):(this._highlight_change_time=null,this.clear_highlight())),this.hide_tooltip(),"stopped"==this._mouse_handler.move&&null!=l&&null!=_){this._replayer.log(`Activating tooltip for item #${_} ...`),this._tooltip.style.visibility="visible",this._tooltip.style.top=e+10+"px",this._tooltip.style.left=t+25+"px";const i=l.style.split(":")[0];this._tooltip.style.borderColor="#"+i;let s=this.nearest_pts.get(this.tile_set.config_id,this.tile_set.zoom_level,this.tile_set.x_offset,this.tile_set.y_offset,t,e,_);if(null==s)return this._tooltip.textContent=l.label,void this._ctxt.send("pt_req",{config:this.tile_set.current_canvas_config(),mouse_x:a,mouse_y:c,item_id:_});this._tooltip.textContent=l.label+"\r\n"+`(${s.data_x}, ${s.data_y})`,this.axis_handler.update_crosshair(s.screen_x,s.screen_y)}}hide_tooltip(){this._tooltip.style.visibility="hidden",this.axis_handler.update_crosshair(null,null)}set_highlight(t,e){this._replayer.log(`>>> Setting highlight to #${t} ...`),this.tile_set.set_highlight(t,e),null!=this._highlighted_label&&this._highlighted_label.item_id!=t&&this._highlighted_label.update_highlight(!1);let i=this._label_map.get(t);null!=i&&(this._highlighted_label=i,i.update_highlight(!0)),this._update_T=this._replayer.rel_time,null!=this._hide_cb&&(window.clearTimeout(this._hide_cb),this._hide_cb=null),this._fg.style.visibility="visible"}clear_highlight(){this._replayer.log("clear_highlight() called."),this.set_hide_cb("clear2",(()=>this.clear_highlight2()),100)}clear_highlight2(){this._replayer.log(">>> Clearing highlight ..."),this.tile_set.set_highlight(null,null),null!=this._highlighted_label&&(this._highlighted_label.update_highlight(!1),this._highlighted_label=null),this.set_hide_cb("clear3",(()=>this.clear_highlight3()),500)}clear_highlight3(){this._replayer.log(">>> Hiding the foreground layer ..."),this._fg.style.visibility="hidden"}set_hide_cb(t,e,i){const s=this._replayer.rel_time,l=s-this._update_T;this._replayer.log(`now = ${s} last update was ${this._update_T} (elasped = ${l}) vs. threshold = ${i}`),l>=i?e():(this._hide_cb&&(window.clearTimeout(this._hide_cb),this._hide_cb=null),this._replayer.log(`hide_cb will fire in ${i-l} ms.`),this._replayer.status!=c.RUNNING&&(this._hide_cb=window.setTimeout((()=>{this._replayer.record_event(t,{}),e()}),i-l)))}autoselect_handler(t){if(this._btn_autoselect.checked){for(let t of this._labels){let e=t.checkbox;null!=e&&(e.checked=!0)}this._ctxt.send("update_selection",{version:this.tile_set.new_sm_version(),how:"exact",pat:this._searchbox.value,regex:this._btn_regex.checked}),this.request_new_tiles()}}search_handler(t){null!=t&&this._btn_autoselect.checked?(this._ctxt.send("search",{version:this.tile_set.new_sm_version(),pat:this._searchbox.value,regex:this._btn_regex.checked}),this.request_new_tiles()):this._ctxt.send("search",{pat:this._searchbox.value,regex:this._btn_regex.checked})}select_btn_handler(t,e){this._btn_autoselect.checked=!1,this._btn_popup.hide();let i={version:this.tile_set.new_sm_version()};"select_all"==e||"deselect_all"==e?(i.pat="",i.regex=!1):(i.pat=this._searchbox.value,i.regex=this._btn_regex.checked),i.how="select_all"==e||"select_matching"==e?"select":"deselect",this._ctxt.send("update_selection",i),this.request_new_tiles();for(let t of this._labels)t.update_selected("select"==i.how)}update_search_result(t){let e=this._labels;this._labels=[];let i=t.labels;i.push([r,!1,"",""]),this.tile_set.highlight_trigger==o.VIA_SEARCH&&null!=this._highlighted_label&&(this._highlighted_label.update_highlight(!1),this._highlighted_label=null,this.clear_highlight());let s=0,l=0;for(;;){const t=e[s].item_id,[_,h,n,o]=i[l];if(t<_){e[s].elem.remove(),this._label_map.delete(t),this._highlighted_label===e[s]&&(this._highlighted_label=null),s++;continue}if(_<t){let t=new R(_,h,n,o,((t,e)=>this.label_mouse_handler(t,e))),i=t.checkbox;i.addEventListener("change",(t=>{this._btn_autoselect.checked=!1,this._ctxt.send("update_selection",{version:this.tile_set.new_sm_version(),how:i.checked?"select":"deselect",ids:[_]}),this.request_new_tiles()})),this._search_result_area.insertBefore(t.elem,e[s].elem),this._labels.push(t),this._label_map.set(_,t),l++;continue}let a=e[s];if(a.update_selected(h),this._labels.push(a),t==r)break;s++,l++}const _=this._labels.length-1;let h="";h=0==_?"No matching items.":1==_?"1 Matching item.":_==t.count?`${_} matching items.`:`Showing ${_} of ${t.count} matching items.`,this._search_stat_area.textContent=h}label_mouse_handler(t,e){this._replayer.log(`label_mouse_handler called: item_id=${t.item_id} event=${e.type} current highlighted=${t.highlighted} classlist = ${t.elem.classList}`);const i="mouseleave"==e.type;if(i||t.highlighted)i&&t.highlighted&&this.clear_highlight();else{this.set_highlight(t.item_id,o.VIA_SEARCH);const e=this.create_highlight_req([{x:null,y:null,item_id:t.item_id}]);null!=e&&(this._replayer.log("Sending highlight_req:",e),this._replayer.status!=c.RUNNING&&this._ctxt.send("tile_req",e))}}request_new_tiles(){const t=this.create_tile_req();null!=t&&(this._replayer.log("Sending new tile_req:",t),this._ctxt.send("tile_req",t))}create_tile_req(){this._tile_update_stalled=!1;let t=this.tile_set.sm_version;if(this._replayer.log(`create_tile_req (version ${t}): currently has ${this._inflight_reqs.size} in-flight requests.`),this.expire_old_requests(),this._inflight_reqs.size>=50)return this._replayer.log("Too many in-flight requests, bailing out ..."),this._tile_update_stalled=!0,null;const e=this.tile_set.get_all_tile_coords();let i=[];for(let[s,l]of e){const e=this.tile_set.tile_key(s,l),_=this.tile_set.get_tile(e);if(null==_||_.sm_version<t){const t=this._next_seq++;this._inflight_reqs.set(t,Date.now()),i.push(`${s}:${l}:${t}`)}}if(0==i.length)return null;const s=this._ack_seqs;return this._ack_seqs=[],{ack_seqs:s,config:this.tile_set.current_canvas_config(),items:[{version:t,prio:i,reg:[]}],throttled:!1}}expire_old_requests(){let t=Date.now()-5e3;for(let[e,i]of this._inflight_reqs)i<t&&(this._replayer.log(`Forgetting old seq #${e} ...`),this._inflight_reqs.delete(e))}}class O{constructor(t,e,i){this._root_node=t,this._ctxt_id=e,this._comm=i(((t,e)=>{this._callback(t,e)}))}dispose(){}get root_node(){return this._root_node}get ctxt_id(){return this._ctxt_id}get comm(){return this._comm}}class P extends O{constructor(t,e,i){super(t,e,i),function(t,e){if(!/^[a-zA-Z0-9-]+$/.test(e))throw console.log(`ctxt_id contains bad characters: [${e}]`),new Error(`ctxt_id contains bad characters: [${e}]`);let i=`\n      <div class="croquis_nbext">\n!       <div class="cr_dbg_btns">\n!         <button>Record</button> <button>Stop</button>\n!         <button>Save</button> <button>Load</button>\n!         <button>Replay</button> <button>Clear</button>\n!         <span>...</span>\n!       </div>\n        <div id="${e}" class="cr_main">\n          <div class="cr_ctrl_panel">\n            <span class="cr_ctrl_btns">\n              <button class="cr_home_btn">&#x1f3e0; Reset</button>\n              <button class="cr_zoom_in_btn">&#x1f50d;<sup>+</sup></button>\n              <button class="cr_zoom_out_btn"><small>&#x1f50d;</small><sup>-</sup></button>\n            </span>\n            &nbsp; Drag mouse to:\n            <input type="radio" name="${e}-radio"\n                   id="${e}-zoom" class="cr_zoom" value="zoom" checked/>\n            <label for="${e}-zoom">zoom</label>\n            <input type="radio" name="${e}-radio"\n                   id="${e}-pan" value="pan"/>\n            <label for="${e}-pan">pan</label>\n          </div>\n          <div class="cr_main1" dir="ltr">\n            \x3c!-- Built by TileHandler. --\x3e\n          </div>\n!         <div class="cr_dbg_status"></div>\n        </div>\n!       <div class="cr_dbglog"><b>Debug logging</b><br /></div>\n      </div>\n    `;i=(t=>t.endsWith("-dbg"))(e)?i.replace(/^!/gm," "):i.split("\n").filter((t=>!/^!/.test(t))).join("\n");const s=document.createElement("template");s.innerHTML=i,t.appendChild(s.content)}(t,e),this._tile_handler=new B(this),this._log_area=t.querySelector(".cr_dbglog"),this._log_area&&this.dbglog("Cell ID = ",e)}dispose(){this.send("cell_fini"),this._tile_handler.cleanup()}send(t,e){let i=e||{};i.msg=t,this._comm.then((t=>t.send(i))).catch((t=>this._tile_handler.status_bar.on_comm_error(t)))}_callback(t,e){if("canvas_config"==t.msg)this._tile_handler.register_canvas_config(t);else if("axis_ticks"==t.msg)this._tile_handler.axis_handler.update(t);else if("tile"==t.msg){let i=new k(t,e),s=t.seqs.split(":").map((t=>parseInt(t)));this._tile_handler.register_tile(i,s)}else"pt"==t.msg?(this._tile_handler.nearest_pts.insert(t),this._tile_handler.recompute_highlight()):"labels"==t.msg?this._tile_handler.update_search_result(t):console.log("Unknown message",t)}dbglog(...t){if(this._log_area){const e=t.map((t=>"object"==typeof t?JSON.stringify(t):t)).join(" ");this._log_area.append(document.createTextNode(e),"<br/>")}}}const U="application/vnd.croquis+json";class j{constructor(t,e){this._parent=t,this._ctxt_id=e}send(t){return this._parent._raw_comm?(t.ctxt_id=this._ctxt_id,this._parent._raw_comm.send(t),Promise.resolve(this)):Promise.reject("comm is closed!")}}class G{constructor(t,e){this.kernel_id=t,this.kernel=e,this._raw_comm=null,this.BE_id=null,this._BE_ready=null,this._BE_ready_resolve=null,this._BE_ready_reject=null,this._ctxt_map=new Map}_ensure_comm_open(t){var e,i;return this.BE_id!=t&&(null!=this.BE_id?console.log(`BE_id changed from ${this.BE_id} to ${t}: re-opening comm ...`):console.log(`Opening comm: ${t}`),this._BE_ready&&(null===(e=this._BE_ready_reject)||void 0===e||e.call(this),this._BE_ready=null,this._BE_ready_resolve=null,this._BE_ready_reject=null),this.BE_id=t,this._BE_ready=new Promise(((t,e)=>{this._BE_ready_resolve=t,this._BE_ready_reject=e})),this._raw_comm=this.kernel.createComm("croquis"),this._raw_comm.onMsg=t=>{this._msg_dispatcher(t)},this._raw_comm.open({msg:"FE_loaded"})),null!==(i=this._BE_ready)&&void 0!==i?i:Promise.reject("Cannot happen!")}_msg_dispatcher(t){var e;const i=t.content.data;if("BE_ready"==i.msg)return console.log("Backend is ready!"),null===(e=this._BE_ready_resolve)||void 0===e||e.call(this),this._BE_ready_resolve=null,void(this._BE_ready_reject=null);const s=i.ctxt_id,l=this._ctxt_map.get(s);l?l(i,t.buffers||[]):console.log("Unknown context ID: ",s)}get_comm(t,e,i){return this._ctxt_map.set(e,i),this._ensure_comm_open(t).then((()=>new j(this,e)))}}class F{constructor(t){this._kernels=new Map,t.forEach((async t=>{this.register(t)})),t.widgetAdded.connect((async(t,e)=>{this.register(e)}))}async register(t){var e;const i=t.context.sessionContext;await i.ready;const s=null===(e=i.session)||void 0===e?void 0:e.kernel,l=null==s?void 0:s.id;s&&null!=l&&this._kernels.set(l,new G(l,s))}get_comm(t,e,i,s){const l=this._kernels.get(t);return l?l.get_comm(e,i,s):Promise.reject("Cannot find kernel!")}}class H extends _.Widget{constructor(t,e,i){super(),this._registry=e,this._ctxt_id=null,this._ctxt=null}dispose(){var t;null===(t=this._ctxt)||void 0===t||t.dispose(),super.dispose()}renderModel(t){var e;const i=null===(e=t.data)||void 0===e?void 0:e[U],s=null==i?void 0:i.kernel_id,l=null==i?void 0:i.BE_id,_=null==i?void 0:i.ctxt_id;return this._ctxt_id=_,null===_?Promise.reject("no ctxt id!"):(this._ctxt=new P(this.node,_,(t=>this._registry.get_comm(s,l,_,t))),this._ctxt.comm.then((()=>{})))}}const V={id:"croquis-js",description:"Frontend plugin for croquis.",autoStart:!0,requires:[l.IRenderMimeRegistry,s.INotebookTracker],activate:async(t,e,i)=>{const s=new F(i),l={safe:!0,mimeTypes:[U],createRenderer:e=>new H(t,s,e)};e.addFactory(l,0)}};console.log("croquis extension loaded !!!");const Z=V}}]);