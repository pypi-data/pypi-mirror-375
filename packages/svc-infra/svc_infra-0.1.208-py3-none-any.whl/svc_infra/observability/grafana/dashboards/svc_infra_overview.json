{
  "title": "Service Infrastructure Overview",
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 2,
  "editable": true,
  "refresh": "5s",
  "panels": [
    {
      "type": "stat",
      "title": "Requests per Second (RPS)",
      "gridPos": { "h": 5, "w": 6, "x": 0, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (job) (rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",method=~\"$method\",route=~\"$route\"}[$__rate_interval]))",
          "legendFormat": "{{job}}"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "orientation": "horizontal" }
    },
    {
      "type": "stat",
      "title": "Error Rate (RPS)",
      "gridPos": { "h": 5, "w": 6, "x": 6, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code!~\"2..|3..\",method=~\"$method\",route=~\"$route\"}[$__rate_interval]))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "orientation": "horizontal" }
    },
    {
      "type": "stat",
      "title": "Error Rate (%)",
      "gridPos": { "h": 5, "w": 6, "x": 12, "y": 0 },
      "fieldConfig": { "defaults": { "unit": "percent" }, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * (sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code!~\"2..|3..\",method=~\"$method\",route=~\"$route\"}[$__rate_interval]))) / clamp_min(sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",method=~\"$method\",route=~\"$route\"}[$__rate_interval])), 1)"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "orientation": "horizontal" }
    },
    {
      "type": "stat",
      "title": "p99 Latency (s)",
      "gridPos": { "h": 5, "w": 6, "x": 18, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "histogram_quantile(0.99, sum by (le) (rate(http_server_request_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\",method=~\"$method\",route=~\"$route\"}[$__rate_interval])))",
          "legendFormat": "p99"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "orientation": "horizontal" }
    },

    {
      "type": "timeseries",
      "title": "Latency Percentiles (p50 / p90 / p99)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 5 },
      "targets": [
        { "refId": "A", "expr": "histogram_quantile(0.5,  sum by (le) (rate(http_server_request_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\",route=~\"$route\"}[$__rate_interval])))", "legendFormat": "p50" },
        { "refId": "B", "expr": "histogram_quantile(0.9,  sum by (le) (rate(http_server_request_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\",route=~\"$route\"}[$__rate_interval])))", "legendFormat": "p90" },
        { "refId": "C", "expr": "histogram_quantile(0.99, sum by (le) (rate(http_server_request_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\",route=~\"$route\"}[$__rate_interval])))", "legendFormat": "p99" }
      ]
    },
    {
      "type": "timeseries",
      "title": "HTTP Requests by Status",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 5 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (code) (rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",method=~\"$method\",route=~\"$route\"}[$__rate_interval]))",
          "legendFormat": "{{code}}"
        }
      ]
    },

    {
      "type": "timeseries",
      "title": "4xx vs 5xx Error Rate",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 13 },
      "targets": [
        { "refId": "A", "expr": "sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code=~\"4..\"}[$__rate_interval]))", "legendFormat": "4xx" },
        { "refId": "B", "expr": "sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code=~\"5..\"}[$__rate_interval]))", "legendFormat": "5xx" }
      ]
    },
    {
      "type": "timeseries",
      "title": "In-flight Requests",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 13 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (route) (http_server_inflight_requests{job=~\"$job\",instance=~\"$instance\",route=~\"$route\"})",
          "legendFormat": "{{route}}"
        }
      ]
    },

    {
      "type": "timeseries",
      "title": "DB Pool: In Use / Available",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 21 },
      "targets": [
        { "refId": "A", "expr": "sum by (job) (db_pool_in_use{job=~\"$job\",instance=~\"$instance\"})", "legendFormat": "in_use" },
        { "refId": "B", "expr": "sum by (job) (db_pool_available{job=~\"$job\",instance=~\"$instance\"})", "legendFormat": "available" }
      ]
    },
    {
      "type": "table",
      "title": "Top Routes by RPS",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 21 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (route) (rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",method=~\"$method\",route!=\"\"}[$__rate_interval])))",
          "legendFormat": "{{route}}"
        }
      ],
      "options": { "showHeader": true }
    },

    {
      "type": "table",
      "title": "Top Slow Routes (p95, s)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 29 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, histogram_quantile(0.95, sum by (route, le) (rate(http_server_request_duration_seconds_bucket{job=~\"$job\",instance=~\"$instance\",route!=\"\"}[$__rate_interval]))))",
          "legendFormat": "{{route}}"
        }
      ],
      "options": { "showHeader": true }
    },
    {
      "type": "table",
      "title": "Top Erroring Routes (5xx RPS)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 29 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (route) (rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code=~\"5..\",route!=\"\"}[$__rate_interval])))",
          "legendFormat": "{{route}}"
        }
      ],
      "options": { "showHeader": true }
    },

    {
      "type": "stat",
      "title": "SLO Burn Rate (5m/1h)",
      "gridPos": { "h": 5, "w": 6, "x": 0, "y": 37 },
      "fieldConfig": { "defaults": { "unit": "ratio" } },
      "targets": [
        {
          "refId": "A",
          "expr": "(sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code=~\"5..|4..\"}[5m])) / clamp_min(sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\"}[5m])),1)) / (sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code=~\"5..|4..\"}[1h])) / clamp_min(sum(rate(http_server_requests_total{job=~\"$job\",instance=~\"$instance\"}[1h])),1))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },
    {
      "type": "stat",
      "title": "Error Budget Used (est. %)",
      "gridPos": { "h": 5, "w": 6, "x": 6, "y": 37 },
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "targets": [
        {
          "refId": "A",
          "expr": "100 * (sum(increase(http_server_requests_total{job=~\"$job\",instance=~\"$instance\",code!~\"2..|3..\"}[1h])) / clamp_min(sum(increase(http_server_requests_total{job=~\"$job\",instance=~\"$instance\"}[1h])),1))"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "type": "timeseries",
      "title": "Instance Health (Prometheus up)",
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 37 },
      "targets": [
        { "refId": "A", "expr": "avg by (job, instance) (up{job=~\"$job\",instance=~\"$instance\"})", "legendFormat": "{{job}}/{{instance}}" }
      ]
    },

    {
      "type": "timeseries",
      "title": "Process CPU (rate seconds)",
      "gridPos": { "h": 7, "w": 8, "x": 0, "y": 42 },
      "targets": [
        { "refId": "A", "expr": "sum by (job, instance) (rate(process_cpu_seconds_total{job=~\"$job\",instance=~\"$instance\"}[$__rate_interval]))", "legendFormat": "{{instance}}" }
      ]
    },
    {
      "type": "timeseries",
      "title": "Process Memory RSS (bytes)",
      "gridPos": { "h": 7, "w": 8, "x": 8, "y": 42 },
      "targets": [
        { "refId": "A", "expr": "sum by (job, instance) (process_resident_memory_bytes{job=~\"$job\",instance=~\"$instance\"})", "legendFormat": "{{instance}}" }
      ]
    },
    {
      "type": "timeseries",
      "title": "Python GC Collections (by gen)",
      "gridPos": { "h": 7, "w": 8, "x": 16, "y": 42 },
      "targets": [
        { "refId": "A", "expr": "rate(python_gc_collections_total{job=~\"$job\",instance=~\"$instance\"}[$__rate_interval])", "legendFormat": "gen={{generation}}" }
      ]
    },

    {
      "type": "timeseries",
      "title": "Scrape Failures (Prometheus)",
      "gridPos": { "h": 6, "w": 24, "x": 0, "y": 49 },
      "targets": [
        { "refId": "A", "expr": "sum by (job, instance) (increase(prometheus_target_scrapes_exceeded_sample_limit_total[$__rate_interval]))", "legendFormat": "{{job}}/{{instance}} (sample limit)" },
        { "refId": "B", "expr": "sum by (job, instance) (increase(prometheus_target_failed_scrapes_total[$__rate_interval]))", "legendFormat": "{{job}}/{{instance}} (failed)" }
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "name": "job",
        "label": "Job",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(job)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": ["All"], "value": ["$__all"] }
      },
      {
        "name": "instance",
        "label": "Instance",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(http_server_requests_total, instance)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": ["All"], "value": ["$__all"] }
      },
      {
        "name": "method",
        "label": "Method",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(http_server_requests_total, method)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": ["All"], "value": ["$__all"] }
      },
      {
        "name": "route",
        "label": "Route",
        "type": "query",
        "datasource": "Prometheus",
        "query": "label_values(http_server_requests_total, route)",
        "refresh": 1,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": ["All"], "value": ["$__all"] }
      }
    ]
  },
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "type": "dashboard",
        "name": "Annotations & Alerts",
        "enable": true,

      } ]
  }
}