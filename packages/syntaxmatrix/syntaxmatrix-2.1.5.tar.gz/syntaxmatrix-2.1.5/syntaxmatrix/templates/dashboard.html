<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="../static/icons/favicon.ico">
    <title>ML Dashboard</title>
    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
        font-size: clamp(0.95rem, 1.7vw, 1.08rem);
        background: #f8f9fb;
        margin: 0;
        padding: 0;
      }
      .dashboard-sidebar {
        position: fixed;
        top: 0; left: 0;
        width: 200px; height: 100vh;
        background: #f1f4f7;
        border-right: 1px solid #ccc;
        padding: 26px 10px 10px 14px;
        box-sizing: border-box;
        overflow-y: auto;    
        z-index: 100;
        font-size: clamp(0.95rem, 2vw, 1.09rem);
      }
      .dashboard-sidebar h2 {
        font-size: clamp(1.12rem, 3vw, 1.28rem);
        color: #007acc;
        margin-top: 0;
        margin-bottom: 32px;
        font-weight: bold;
        letter-spacing: 1px;
      }
      .sidebar-links {
        margin-top: 22px;
      }
      .sidebar-links a {
        display: block;
        padding: 12px 10px 12px 0;
        color: #333;
        text-decoration: none;
        font-size: clamp(0.93rem, 2vw, 1.08rem);
        border-radius: 6px;
        margin-bottom: 6px;
        transition: background 0.2s, color 0.2s;
      }
      .sidebar-links a.active,
      .sidebar-links a:hover {
        background: #e0e5ee;
        color: #007acc;
        font-weight: bold;
      }
      .dashboard-main {
        margin-left: 220px;
        padding: 36px 40px 30px 10px;
        min-height: 100vh;
        box-sizing: border-box;
        overflow-x: auto;
        background: #f8f9fb;
        font-size: clamp(0.98rem, 2vw, 1.07rem);
      }
      .dashboard-tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0 0 12px 0;
        border-bottom: 2px solid #ccc;
        background: none;
      }
      .dashboard-tabs li { margin: 0 8px; }
      .dashboard-tabs a {
        display: inline-block; padding: 12px 32px; text-decoration: none; color: #333; font-size: clamp(0.96rem, 2vw, 1.1em);
        border-radius: 8px 8px 0 0;
        background: #e0e5ee;
        border: 1px solid #ccc;
        border-bottom: none;
        margin-bottom: -2px;
      }
      .dashboard-tabs .active a, .dashboard-tabs a.active {
        background: #fff;
        border-bottom: 2px solid #f8f9fb;
        font-weight: bold;
        color: #007acc;
        position: relative;
        top: 2px;
      }
      .dashboard-content {
        background: #fff;
        width: 100%;
        padding: 36px 32px 32px 32px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 3px 12px rgba(80,120,160,0.08);
        min-height: 320px;
        border: 1px solid #ccc;
        overflow-x: auto;
        margin-right: 1vw; 
      }
      .dashboard-content h2, .dashboard-content h4 {
        font-size: clamp(1.06rem, 2.5vw, 1.5rem);
      }
      .smx-table {
        font-size: clamp(0.86rem, 1.8vw, 1.01rem);
        padding: clamp(3px, 1vw, 9px) clamp(4px, 2vw, 13px);
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 16px;
        font-size: 0.98em;
        background: #fff;
        display: block;
        overflow-x: auto;
      }
      .smx-table th {
        position: sticky;
        top: 0;
        background: #e0e5ee;
        font-weight: bold;
        padding: 8px 10px;
        border-bottom: 2px solid #ccc;
        z-index: 2;
      }
      .smx-table td {
        border: 1px solid #ddd;
        padding: 7px 10px;
      }
      @media (max-width: 900px) {
        .dashboard-sidebar {
          width: 110px;
          padding: 10px 2vw 6px 2vw;
        }
        .dashboard-main {
          margin-left: 110px;
          padding: clamp(8px, 2vw, 14px) clamp(2vw, 2vw, 10px);
        }
      }   
       .smx-table {
          border-collapse: collapse;
          font-size: 13px;
      }
      .smx-table th,
      .smx-table td {
          padding: 4px 8px;
          white-space: nowrap;   
      }
      .smx-scroll {
          overflow-x: auto;        
          overflow-y: hidden;    
          max-width: 100%;         
      }
      .smx-table {
          width: max-content;      
          border-collapse: collapse;
          font-size: 13px;
      }

      .smx-table th,
      .smx-table td {
          padding: 4px 8px;
          white-space: nowrap;    
      }
      #form-askai {
        display: flex;
        flex-direction: column;
        align-items: flex-center; /* or 'center' for centered alignment */
        gap: 16px; 
      }
  
      button {
        padding: 8px 10px;
        font-size: 1em;
        background: #007acc;
        color: #fff;
        border: none;
        border-radius: 4px;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      button:hover { background: #005fa3; }
      input.btn { cursor: pointer; padding: 10px; }
      .del-btn {
        border-radius:40%;
        cursor:pointer;
        background:none; 
        padding:0.2rem;
      }
      .del-btn:hover { opacity:0.8; background:red; }
   
      /* full-screen overlay */
      #loader-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(241, 235, 235, 0);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      /* simple spinner */
      .loader {
        border: 8px solid #eee;
        border-top: 8px solid #333;
        border-radius: 50%;
        width: 60px; height: 60px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div id="loader-overlay">
    <div class="loader"></div>
  </div>
  <div class="dashboard-sidebar">
    <h2>ML&nbsp;Lab</h2>
    <a href="/">return to home</a>
    <div class="sidebar-links">
      <a href="/dashboard?section=explore"{% if section == 'explore' %} class="active"{% endif %}>Explore</a>
      
      <!-- Future: more links here -->
    </div>
  </div>
  <div class="dashboard-main">
    <ul class="dashboard-tabs">
      <li class="{{ 'active' if section == 'explore' else '' }}"><a href="/dashboard?section=explore">Explore</a></li>
    </ul>
    <div class="dashboard-content">
      <!-- FLASH MESSAGES (optional but useful) -->
      {% with msgs = get_flashed_messages() %}
        {% if msgs %}
          <ul class="flashes">
            {% for m in msgs %}
              <li>{{ m }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
      <!-- Upload form -->
      <div style="width:70vw; margin-bottom:10px; border:1px solid gray; border-radius:10px; padding:10px;">
        <form action="/dashboard/upload" method="post" enctype="multipart/form-data" style="padding:5px; margin-bottom:5px;">
          <input style="cursor:pointer;" type="file" name="dataset_file" accept=".csv" required>
          <button type="submit">Upload CSV</button>
        </form>
      
        <!-- Dataset selection dropdown -->
        {% if datasets %}
          <form method="get" action="/dashboard" style="margin-top:45px; margin-bottom:8px;padding:5px;">
            <input type="hidden" name="section" value="explore"/>
            <label for="dataset_select"><strong>Select dataset:</strong></label>
            <select name="dataset" id="dataset_select" onchange="this.form.submit()" style="margin-top:5px; height:24px;">
              {% for ds in datasets %}
                <option value="{{ ds }}" {% if ds == selected_dataset %}selected{% endif %}>{{ ds }}</option>
              {% endfor %}
            </select>
          </form>
            <div>
              <form  method="post" action="{{ url_for('delete_dataset', dataset_name=selected_dataset) }}"
                  style="display:inline-block;">
                <div>Current dataset: 
                    <strong style="margin:10px;color:green; background:yellow;">{{ selected_dataset }}</strong>
                    <button class="del-btn" type="submit" title="Delete {{ selected_dataset }}"
                          onclick="return confirm('Delete {{ selected_dataset }}?');">
                          üóëÔ∏è   
                    </button>
                </div>
          </form>
        {% else %}
          <p style="color:red; padding:5px;">No datasets uploaded yet. Upload a CSV to begin.</p>
        {% endif %}     
      </div>
      {% if section == 'explore' %}
        <br>
        <h2>Explore Data</h2>
        <form id="form-askai" method="post" action="/dashboard?section=explore" style="margin-top:5px;padding:12px; border:1px solid grey;border-radius:5px;width:70vw;">
          <input type="hidden" name="dataset" value="{{ selected_dataset }}">
          <label for="askai"><strong>Ask smxAI:</strong></label>
          <textarea id="askai" name="askai_question" type="text" rows="4"
                  style="position:relative; width:90%; padding:8px; font-size:0.8em; border-radius:8px;"
                  placeholder="Ask me about {{ (selected_dataset or 'your dataset. Upload it first.').replace('_', ' ').replace('.csv', '') }}" required></textarea>
          <button type="submit" style="font-size:1.2rem; width:8rem; padding:4px;">Submit</button>
        </form>
          {% if askai_question %}
            <div class="askai-qblock" style="margin:20px 5px;">
                <span class="askai-q-label"><b>Q:</b></span>
                <span class="askai-q">{{ askai_question }}</span>
            </div>
          <!--
          {% if refined_question and refined_question != askai_question %}
              <div class="refined-qblock">
                  <span class="refined-q-label"><b>Refined Q:</b></span>
                  <span class="refined-q">{{ refined_question }}</span>
              </div>
          {% endif %}
          -->
          {% if ai_outputs %}
            <div class="d-flex align-items-center justify-content-between" style="margin-bottom:8px;">
              <h3 class="m-0">Result</h3>
            </div>
            {% for html_block in ai_outputs %}
                <div class="ai-output" style="margin-bottom:18px;overflow-x:auto; max-width:100%;">
                    {{ html_block | safe }}
                </div>
            {% endfor %}
          {% endif %}

          {% if ai_code %}
            <div>
                <a href="#" onclick="toggleCode();return false;" id="toggle-link">Show Code</a>
                <pre id="ai-code-block" style="display:none; background:#222; color:#eee; padding:10px; border-radius:8px; overflow:auto;">{{ ai_code }}</pre>
            </div>
            <script>
                function toggleCode() {
                    var el = document.getElementById('ai-code-block');
                    var link = document.getElementById('toggle-link');
                    if (el.style.display === 'none') {
                        el.style.display = '';
                        link.innerText = 'Hide Code';
                    } else {
                        el.style.display = 'none';
                        link.innerText = 'Show Code';
                    }
                }
            </script>
          {% endif %}
        {% endif %}
        {% for cell in data_cells %}
          <h4>{{ cell.title }}</h4>
          <div style="overflow-x:auto; max-width:100%;">
            {{ cell.output|safe }}
            {% set data_code = cell.code %}
            {% include 'code_cell.html' %}
          </div>
        {% endfor %}

      {% elif section == 'analyze' %}
        <h2>Analyze Data</h2>
        <p>Statistical tests, group comparison, feature selection, etc. will go here.</p>
      {% elif section == 'model' %}
        <h2>Model</h2>
        <p>Train/test ML models, evaluate metrics, feature importance, etc. will go here.</p>
      {% else %}
        <h2>Section not found</h2>
      {% endif %}
    </div>
  </div>
  <script>
    function toggleCodeCell(link) {
      var cell = link.nextElementSibling;
      if (!cell) return;
      if (cell.style.display === "none") {
        cell.style.display = "block";
        link.querySelector("span").innerText = "Hide Code";
      } else {
        cell.style.display = "none";
        link.querySelector("span").innerText = "Show Code";
      }
    }
    function copyCodeToClipboard(btn) {
      var pre = btn.parentElement.querySelector("pre");
      if (!pre) return;
      var range = document.createRange();
      range.selectNodeContents(pre);
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try {
        document.execCommand("copy");
        btn.innerText = "Copied!";
        setTimeout(() => { btn.innerText = "Copy"; }, 1200);
      } catch (err) {
        btn.innerText = "Failed!";
        setTimeout(() => { btn.innerText = "Copy"; }, 1200);
      }
      sel.removeAllRanges();
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("form-askai");
      const overlay = document.getElementById("loader-overlay");
      form.addEventListener("submit", () => {
        overlay.style.display = "flex";
      });
    });
  </script>
</body>
</html>
