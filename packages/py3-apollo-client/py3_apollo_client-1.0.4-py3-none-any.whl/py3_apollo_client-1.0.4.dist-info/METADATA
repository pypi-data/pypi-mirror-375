Metadata-Version: 2.4
Name: py3-apollo-client
Version: 1.0.4
Summary: Python3 Client for Ctrip's Apollo
Author-email: renw <renwei_8080@126.com>
License-Expression: MIT
Project-URL: homepage, https://github.com/renw87/py3-apollo-client
Project-URL: repository, https://github.com/renw87/py3-apollo-client
Keywords: apollo
Requires-Python: >=3.6.0
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: loguru
Requires-Dist: PyYAML
Dynamic: license-file

py3-apollo-client - Python3 Client for Ctrip's Apollo
================
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

方便Python接入配置中心框架 [Apollo](https://github.com/ctripcorp/apollo) 所开发的Python版本客户端。

基于 [onecer/apollo-python](https://github.com/onecer/apollo-python)  修改， 主要修复配置未更新也会触发`change_listener`

## 链接
-----

- [GitHub](https://github.com/renw87/py3-apollo-client)
- [PyPI](https://pypi.org/project/py3-apollo-client)

## 依赖
-----

- python 3.x

## 安装
-----

```bash
pip install py3-apollo-client
```

## 使用
-----

导入包
```
from py3_apollo import ApolloClient
```

```
app_id = 'demo-service'
config_url = 'http://127.0.0.1:8080'
cluster = 'default'
secret = ''
env = 'DEV'

client = ApolloClient(app_id=app_id, config_url=config_url, cluster=cluster, secret=secret, env=env)
lm_API_KEY = client.get_value("lm_API_KEY")
```

也默认支持通过环境变量来传递值,基本和 Java 客户端保持一致

## 客户端初始化参数

| 参数               | 说明            | 默认值                   | 环境变量                       |
|:-----------------|:--------------|:----------------------|:---------------------------|
| app_id           | 应用名           | 无                     | APP_ID                     |
| config_url       | 配置中心地址        | http://127.0.0.1:8080 | ${ENV}_META or APOLLO_META |
| cluster          | 集群名           | default               | IDC                        |
| secret           | 访问密钥          | 无                     | APOLLO_ACCESS_KEY_SECRET   |
| env              | 环境            | DEV                   | ENV                        |
| client_ip        | 客户端ip         | 获取当前 IP               | CLIENT_IP                  |
| cache_path       | 配置缓存路径        | tmp/apollo/cache      | APOLLO_CACHE_PATH          |
| need_hot_update  | 是否需要热更新       | True                  | -                          |
| change_listener  | 配置变更监听器(回调函数) | None                  | -                          |
| log_level        | 日志级别          | INFO                  | LOG_LEVEL                  |
| notification_map | 通知配置 (dict)   | None                  | -                          |

### 配置变更监听器 change_listener

```python
"""
接受 4 个参数 
action：delete \ add  \ update
namespace：namespace
key：key
old_value：old_value
"""
def change_listener(action, namespace, key, old_value):
    print(f"action:{action} namespace: {namespace} key: {key} old_value: {old_value}")
```

### 通知配置 notification_map

```python
notification_map = {
    "application": ["application"],
    "application.yml": ["application.yml"]
}
```

## 配置优先级

*** 环境变量 > 代码配置 ***

如果环境变量存在，则优先使用环境变量的值。

如果环境中存在 ENV的环境变量, 如 ENV=DEV。则优先组合出  `DEV_META` 这个环境变量名称来获取 config url。 如果该环境变量不存在，则取 `APOLLO_META` 环境变量的值。如果 `APOLLO_META` 也不存在，则使用代码定义的 config_url 的值。

其它环境变量同理，以此类推。

### 热更新

默认会启动一个线程来定时更新本地缓存的配置，所以，如果每次用的是 get_value 来获取配置，可以实现配置热更新。


## 本地打包 wheel 

```
# install uv
pip install uv

# build
uv build

# upload
uv publish --token <TOKEN>

```

## License
-------

This is free and unencumbered software released into the public domain.

Anyone is free to copy, modify, publish, use, compile, sell, or
distribute this software, either in source code form or as a compiled
binary, for any purpose, commercial or non-commercial, and by any means.

  [My Blog]: [https://uublog.com](https://uublog.com)
