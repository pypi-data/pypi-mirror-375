# This file is auto-generated by generate_tools.py. DO NOT EDIT.
import logging
from pydantic import ValidationError
from multiconn_archicad.basic_types import Port
from tapir_archicad_mcp.context import multi_conn_instance
from tapir_archicad_mcp.tools.tool_registry import register_tool_for_dispatch
import time
from typing import Any
from tapir_archicad_mcp.pagination import handle_paginated_request, PAGINATION_CACHE, CACHE_LIFETIME_SECONDS

from multiconn_archicad.models.tapir.commands import (
    CreatePropertyDefinitionsParameters,
CreatePropertyDefinitionsResult,
CreatePropertyGroupsParameters,
CreatePropertyGroupsResult,
DeletePropertyDefinitionsParameters,
DeletePropertyDefinitionsResult,
DeletePropertyGroupsParameters,
DeletePropertyGroupsResult,
GetAllPropertiesResult,
GetPropertyValuesOfAttributesParameters,
GetPropertyValuesOfAttributesResult,
GetPropertyValuesOfElementsParameters,
GetPropertyValuesOfElementsResult,
SetPropertyValuesOfAttributesParameters,
SetPropertyValuesOfAttributesResult,
SetPropertyValuesOfElementsParameters,
SetPropertyValuesOfElementsResult
)


log = logging.getLogger()

def create_property_definitions(port: int, params: CreatePropertyDefinitionsParameters) -> CreatePropertyDefinitionsResult:
    """
    Creates Custom Property Definitions based on the given parameters.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="CreatePropertyDefinitions",
            parameters=params.model_dump(mode='json')
        )
        return CreatePropertyDefinitionsResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for CreatePropertyDefinitions result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing CreatePropertyDefinitions on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    create_property_definitions,
    name="properties_create_property_definitions",
    title="CreatePropertyDefinitions",
    description="Creates Custom Property Definitions based on the given parameters.",
    params_model=CreatePropertyDefinitionsParameters,
    result_model=CreatePropertyDefinitionsResult
)


def create_property_groups(port: int, params: CreatePropertyGroupsParameters) -> CreatePropertyGroupsResult:
    """
    Creates Property Groups based on the given parameters.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="CreatePropertyGroups",
            parameters=params.model_dump(mode='json')
        )
        return CreatePropertyGroupsResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for CreatePropertyGroups result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing CreatePropertyGroups on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    create_property_groups,
    name="properties_create_property_groups",
    title="CreatePropertyGroups",
    description="Creates Property Groups based on the given parameters.",
    params_model=CreatePropertyGroupsParameters,
    result_model=CreatePropertyGroupsResult
)


def delete_property_definitions(port: int, params: DeletePropertyDefinitionsParameters) -> DeletePropertyDefinitionsResult:
    """
    Deletes the given Custom Property Definitions.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="DeletePropertyDefinitions",
            parameters=params.model_dump(mode='json')
        )
        return DeletePropertyDefinitionsResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for DeletePropertyDefinitions result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing DeletePropertyDefinitions on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    delete_property_definitions,
    name="properties_delete_property_definitions",
    title="DeletePropertyDefinitions",
    description="Deletes the given Custom Property Definitions.",
    params_model=DeletePropertyDefinitionsParameters,
    result_model=DeletePropertyDefinitionsResult
)


def delete_property_groups(port: int, params: DeletePropertyGroupsParameters) -> DeletePropertyGroupsResult:
    """
    Deletes the given Custom Property Groups.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="DeletePropertyGroups",
            parameters=params.model_dump(mode='json')
        )
        return DeletePropertyGroupsResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for DeletePropertyGroups result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing DeletePropertyGroups on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    delete_property_groups,
    name="properties_delete_property_groups",
    title="DeletePropertyGroups",
    description="Deletes the given Custom Property Groups.",
    params_model=DeletePropertyGroupsParameters,
    result_model=DeletePropertyGroupsResult
)


class PaginatedGetAllPropertiesResult(GetAllPropertiesResult):
    """A paginated version of the GetAllPropertiesResult."""
    properties: list[Any]
    next_page_token: str | None = None


def get_all_properties(port: int, page_token: str | None = None) -> PaginatedGetAllPropertiesResult:
    """
    Returns all user defined and built-in properties.
        This response is paginated. If 'next_page_token' is returned, call this function
        again with that token to get the next page of results.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        cache_key = f"{port}:GetAllProperties"

        if not page_token:
            full_response_dict = conn_header.core.post_tapir_command(
                command="GetAllProperties",
                parameters={}
            )
            full_response_model = GetAllPropertiesResult.model_validate(full_response_dict)
            PAGINATION_CACHE[cache_key] = (full_response_model, time.time())

        if cache_key not in PAGINATION_CACHE:
            raise ValueError("Pagination session expired or invalid. Please start a new request.")

        full_response_model, timestamp = PAGINATION_CACHE[cache_key]
        if time.time() - timestamp > CACHE_LIFETIME_SECONDS:
            del PAGINATION_CACHE[cache_key]
            raise ValueError("Pagination session expired. Please start a new request.")

        list_to_paginate = getattr(full_response_model, "properties")
        paginated_result = handle_paginated_request(list_to_paginate, page_token)

        response_data = full_response_model.model_dump()
        response_data["properties"] = paginated_result.items
        response_data["next_page_token"] = paginated_result.next_page_token

        return PaginatedGetAllPropertiesResult.model_validate(response_data)

    except ValidationError as e:
        log.error(f"Validation error for GetAllProperties result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing GetAllProperties on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    get_all_properties,
    name="properties_get_all_properties",
    title="GetAllProperties",
    description="Returns all user defined and built-in properties.",
    params_model=None,
    result_model=PaginatedGetAllPropertiesResult
)


def get_property_values_of_attributes(port: int, params: GetPropertyValuesOfAttributesParameters) -> GetPropertyValuesOfAttributesResult:
    """
    Returns the property values of the attributes for the given property.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="GetPropertyValuesOfAttributes",
            parameters=params.model_dump(mode='json')
        )
        return GetPropertyValuesOfAttributesResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for GetPropertyValuesOfAttributes result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing GetPropertyValuesOfAttributes on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    get_property_values_of_attributes,
    name="properties_get_property_values_of_attributes",
    title="GetPropertyValuesOfAttributes",
    description="Returns the property values of the attributes for the given property.",
    params_model=GetPropertyValuesOfAttributesParameters,
    result_model=GetPropertyValuesOfAttributesResult
)


def get_property_values_of_elements(port: int, params: GetPropertyValuesOfElementsParameters) -> GetPropertyValuesOfElementsResult:
    """
    Returns the property values of the elements for the given property. It works for subelements of hierarchal elements also.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="GetPropertyValuesOfElements",
            parameters=params.model_dump(mode='json')
        )
        return GetPropertyValuesOfElementsResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for GetPropertyValuesOfElements result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing GetPropertyValuesOfElements on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    get_property_values_of_elements,
    name="properties_get_property_values_of_elements",
    title="GetPropertyValuesOfElements",
    description="Returns the property values of the elements for the given property. It works for subelements of hierarchal elements also.",
    params_model=GetPropertyValuesOfElementsParameters,
    result_model=GetPropertyValuesOfElementsResult
)


def set_property_values_of_attributes(port: int, params: SetPropertyValuesOfAttributesParameters) -> SetPropertyValuesOfAttributesResult:
    """
    Sets the property values of attributes.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="SetPropertyValuesOfAttributes",
            parameters=params.model_dump(mode='json')
        )
        return SetPropertyValuesOfAttributesResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for SetPropertyValuesOfAttributes result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing SetPropertyValuesOfAttributes on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    set_property_values_of_attributes,
    name="properties_set_property_values_of_attributes",
    title="SetPropertyValuesOfAttributes",
    description="Sets the property values of attributes.",
    params_model=SetPropertyValuesOfAttributesParameters,
    result_model=SetPropertyValuesOfAttributesResult
)


def set_property_values_of_elements(port: int, params: SetPropertyValuesOfElementsParameters) -> SetPropertyValuesOfElementsResult:
    """
    Sets the property values of elements. It works for subelements of hierarchal elements also.
    """
    multi_conn = multi_conn_instance.get()
    target_port = Port(port)
    if target_port not in multi_conn.active:
        raise ValueError(f"Port {port} is not an active Archicad connection.")
    conn_header = multi_conn.active[target_port]
    try:

        result_dict = conn_header.core.post_tapir_command(
            command="SetPropertyValuesOfElements",
            parameters=params.model_dump(mode='json')
        )
        return SetPropertyValuesOfElementsResult.model_validate(result_dict)

    except ValidationError as e:
        log.error(f"Validation error for SetPropertyValuesOfElements result: {e}")
        raise ValueError(f"Received an invalid response from the Archicad API: {e}")
    except Exception as e:
        log.error(f"Error executing SetPropertyValuesOfElements on port {port}: {e}")
        raise e


register_tool_for_dispatch(
    set_property_values_of_elements,
    name="properties_set_property_values_of_elements",
    title="SetPropertyValuesOfElements",
    description="Sets the property values of elements. It works for subelements of hierarchal elements also.",
    params_model=SetPropertyValuesOfElementsParameters,
    result_model=SetPropertyValuesOfElementsResult
)
