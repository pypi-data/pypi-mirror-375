<!-- templates/blocks/recaptcha.html -->
<div class="recaptcha-container {{ value.css_classes }}" data-recaptcha-id="{{ block.id }}">
    
    {% if has_recaptcha_keys %}
        <!-- reCAPTCHA v2 (checkbox + desafio) -->
        <div class="g-recaptcha" 
             data-sitekey="{{ recaptcha_public_key }}"
             data-theme="{{ value.tema }}"
             data-size="{{ value.tamanho }}"
             data-callback="onRecaptchaSuccess{{ block.id }}"
             data-expired-callback="onRecaptchaExpired{{ block.id }}"
             data-error-callback="onRecaptchaError{{ block.id }}"
             id="recaptcha-{{ block.id }}">
        </div>
        
        <!-- Status da verifica√ß√£o -->
        <div id="status-{{ block.id }}" class="recaptcha-status mt-3" style="display: none;">
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> 
                <strong>Verifica√ß√£o completa!</strong> 
                Voc√™ passou no teste reCAPTCHA.
            </div>
        </div>
        
        <!-- Status de erro -->
        <div id="error-{{ block.id }}" class="recaptcha-error mt-3" style="display: none;">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Erro no reCAPTCHA!</strong> 
                Tente novamente.
            </div>
        </div>
        
    {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>reCAPTCHA n√£o configurado!</strong>
            <br><small>Configure RECAPTCHA_PUBLIC_KEY no settings.py</small>
        </div>
    {% endif %}
</div>

<script>
// Callback quando o usu√°rio completa o reCAPTCHA
window.onRecaptchaSuccess{{ block.id }} = function(response) {
    console.log('‚úÖ reCAPTCHA completado com sucesso!');
    console.log('Token recebido:', response);
    
    // Mostrar mensagem de sucesso
    const statusDiv = document.getElementById('status-{{ block.id }}');
    const errorDiv = document.getElementById('error-{{ block.id }}');
    
    if (statusDiv) statusDiv.style.display = 'block';
    if (errorDiv) errorDiv.style.display = 'none';
    
    // Marcar como verificado
    const container = document.querySelector('[data-recaptcha-id="{{ block.id }}"]');
    container.setAttribute('data-verified', 'true');
    container.setAttribute('data-response', response);
    container.classList.add('recaptcha-verified');
    container.classList.remove('recaptcha-error');
    
    // Disparar evento personalizado para integra√ß√£o
    document.dispatchEvent(new CustomEvent('recaptchaCompleted', {
        detail: { 
            blockId: '{{ block.id }}', 
            response: response,
            success: true
        }
    }));
    
    // Habilitar bot√µes de submit se existirem
    const submitButtons = document.querySelectorAll('button[type="submit"], input[type="submit"]');
    submitButtons.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('disabled');
    });
};

// Callback quando expira
window.onRecaptchaExpired{{ block.id }} = function() {
    console.log('‚ö†Ô∏è reCAPTCHA expirado');
    
    const statusDiv = document.getElementById('status-{{ block.id }}');
    const errorDiv = document.getElementById('error-{{ block.id }}');
    
    if (statusDiv) statusDiv.style.display = 'none';
    if (errorDiv) {
        errorDiv.querySelector('.alert').innerHTML = `
            <i class="fas fa-clock"></i> 
            <strong>reCAPTCHA expirado!</strong> 
            Clique novamente para verificar.
        `;
        errorDiv.style.display = 'block';
    }
    
    const container = document.querySelector('[data-recaptcha-id="{{ block.id }}"]');
    container.setAttribute('data-verified', 'false');
    container.classList.remove('recaptcha-verified');
    container.classList.add('recaptcha-error');
    
    // Desabilitar bot√µes de submit
    const submitButtons = document.querySelectorAll('button[type="submit"], input[type="submit"]');
    submitButtons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('disabled');
    });
};

// Callback de erro
window.onRecaptchaError{{ block.id }} = function() {
    console.log('‚ùå Erro no reCAPTCHA');
    
    const statusDiv = document.getElementById('status-{{ block.id }}');
    const errorDiv = document.getElementById('error-{{ block.id }}');
    
    if (statusDiv) statusDiv.style.display = 'none';
    if (errorDiv) {
        errorDiv.querySelector('.alert').innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Erro no reCAPTCHA!</strong> 
            Verifique sua conex√£o e tente novamente.
        `;
        errorDiv.style.display = 'block';
    }
    
    const container = document.querySelector('[data-recaptcha-id="{{ block.id }}"]');
    container.setAttribute('data-verified', 'false');
    container.classList.remove('recaptcha-verified');
    container.classList.add('recaptcha-error');
};

// Utilit√°rios p√∫blicos para JavaScript
window.recaptchaUtils{{ block.id }} = {
    isVerified: function() {
        const container = document.querySelector('[data-recaptcha-id="{{ block.id }}"]');
        return container && container.getAttribute('data-verified') === 'true';
    },
    
    getResponse: function() {
        const container = document.querySelector('[data-recaptcha-id="{{ block.id }}"]');
        return container ? (container.getAttribute('data-response') || '') : '';
    },
    
    reset: function() {
        if (typeof grecaptcha !== 'undefined') {
            try {
                grecaptcha.reset();
                console.log('üîÑ reCAPTCHA resetado');
            } catch (e) {
                console.log('‚ö†Ô∏è Erro ao resetar reCAPTCHA:', e);
            }
        }
        
        const container = document.querySelector('[data-recaptcha-id="{{ block.id }}"]');
        if (container) {
            container.setAttribute('data-verified', 'false');
            container.classList.remove('recaptcha-verified', 'recaptcha-error');
        }
        
        const statusDiv = document.getElementById('status-{{ block.id }}');
        const errorDiv = document.getElementById('error-{{ block.id }}');
        
        if (statusDiv) statusDiv.style.display = 'none';
        if (errorDiv) errorDiv.style.display = 'none';
    },
    
    execute: function() {
        if (typeof grecaptcha !== 'undefined') {
            try {
                grecaptcha.execute();
                console.log('‚ñ∂Ô∏è reCAPTCHA executado');
            } catch (e) {
                console.log('‚ö†Ô∏è Erro ao executar reCAPTCHA:', e);
            }
        }
    }
};

// Carregar script do Google reCAPTCHA (apenas uma vez)
if (!document.querySelector('script[src*="recaptcha/api.js"]') && {{ has_recaptcha_keys|yesno:"true,false" }}) {
    const script = document.createElement('script');
    script.src = 'https://www.google.com/recaptcha/api.js';
    script.async = true;
    script.defer = true;
    
    script.onload = function() {
        console.log('üì° reCAPTCHA carregado com sucesso!');
    };
    
    script.onerror = function() {
        console.log('‚ùå Erro ao carregar reCAPTCHA do Google');
        
        const errorDiv = document.getElementById('error-{{ block.id }}');
        if (errorDiv) {
            errorDiv.querySelector('.alert').innerHTML = `
                <i class="fas fa-wifi"></i> 
                <strong>Erro de conex√£o!</strong> 
                N√£o foi poss√≠vel carregar o reCAPTCHA.
            `;
            errorDiv.style.display = 'block';
        }
    };
    
    document.head.appendChild(script);
    console.log('üì° Carregando reCAPTCHA do Google...');
}

// Event listener global para debug
document.addEventListener('recaptchaCompleted', function(e) {
    console.log('üéâ Evento reCAPTCHA global:', e.detail);
});

// Debug: informa√ß√µes da configura√ß√£o
console.log('üîç reCAPTCHA Config:');
console.log('- Block ID:', '{{ block.id }}');
console.log('- Public Key:', '{{ recaptcha_public_key|truncatechars:20 }}...');
console.log('- Has Keys:', {{ has_recaptcha_keys|yesno:"true,false" }});
console.log('- Tema:', '{{ value.tema }}');
console.log('- Tamanho:', '{{ value.tamanho }}');
</script>

<style>
.recaptcha-container {
    margin: 20px 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.recaptcha-container .g-recaptcha {
    margin: 10px 0;
}

/* Estado verificado */
.recaptcha-container.recaptcha-verified {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

.recaptcha-container.recaptcha-verified::before {
    content: '‚úÖ Verificado com Sucesso';
    display: block;
    color: #155724;
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 14px;
    text-align: center;
}

/* Estado de erro */
.recaptcha-container.recaptcha-error {
    border-color: #dc3545;
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
}

.recaptcha-container.recaptcha-error::before {
    content: '‚ùå Erro na Verifica√ß√£o';
    display: block;
    color: #721c24;
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 14px;
    text-align: center;
}

/* Anima√ß√µes */
.recaptcha-status .alert,
.recaptcha-error .alert {
    margin-bottom: 0;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsivo */
@media (max-width: 576px) {
    .recaptcha-container {
        padding: 15px;
        margin: 15px 0;
    }
    
    .recaptcha-container .g-recaptcha {
        transform: scale(0.9);
        transform-origin: center;
    }
}

/* Integra√ß√£o com formul√°rios */
.recaptcha-container + form button[type="submit"].disabled,
.recaptcha-container + form input[type="submit"].disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Classes CSS personalizadas */
.recaptcha-container.text-center {
    text-align: center;
}

.recaptcha-container.my-4 {
    margin: 1.5rem 0;
}

.recaptcha-container.mx-auto {
    margin-left: auto;
    margin-right: auto;
}

/* Tema escuro */
.recaptcha-container[data-theme="dark"] {
    background: #343a40;
    border-color: #495057;
    color: #fff;
}

.recaptcha-container[data-theme="dark"].recaptcha-verified {
    background: linear-gradient(135deg, #1e5c3a 0%, #28a745 100%);
}

.recaptcha-container[data-theme="dark"].recaptcha-error {
    background: linear-gradient(135deg, #5c1e1e 0%, #dc3545 100%);
}
</style>